<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>원료 수불 관리 프로그램</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- SheetJS 라이브러리 추가 (엑셀 저장용) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
        }
        .table-cell {
            padding: 0.75rem;
            vertical-align: middle;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        #inventory-list tr, #receiving-list tr, #issuing-list tr {
            cursor: pointer;
        }
        .remarks-cell {
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* Adjust as needed */
        }
        .sortable {
            cursor: pointer;
            position: relative;
        }
        .sortable::after { content: '↕'; position: absolute; right: 10px; color: #9ca3af; opacity: 0.5; }
        .sortable.asc::after { content: '↑'; opacity: 1; }
        .sortable.desc::after { content: '↓'; opacity: 1; }
        .converted-value {
            color: #3b82f6; /* blue-500 */
            font-weight: 600;
            cursor: pointer;
        }

        /* 인쇄용 스타일 */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: white;
            }
            #app {
                padding: 0;
            }
            #content-area > div {
                display: none !important;
            }
            #content-area > div:not(.hidden) {
                display: block !important;
                box-shadow: none;
                padding: 0;
            }
            table {
                font-size: 10px;
                border-collapse: collapse;
            }
            .table-cell, th, td {
                border: 1px solid #ddd;
                padding: 4px;
            }
            th.no-print-col, td.no-print-col {
                display: none; /* 작업 열 숨기기 */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">원료 수불 관리 프로그램</h1>
            <p class="text-gray-600 mt-2">원료의 입고, 출고 및 재고를 실시간으로 관리합니다.</p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="manage-units-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">단위 관리</button>
                <button id="print-btn" class="bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700 transition-colors">인쇄</button>
                <button id="save-btn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700 transition-colors">엑셀로 저장</button>
            </div>
        </header>

        <!-- 입고 관리 -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8 no-print">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">원료 입고 등록</h2>
            <form id="receiving-form" class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column: Input Fields -->
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label for="receive-date" class="text-sm font-medium text-gray-700 mb-1">입고일</label>
                            <input type="date" id="receive-date" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="receive-material-name" class="text-sm font-medium text-gray-700 mb-1">원료명</label>
                            <input type="text" id="receive-material-name" placeholder="원료명" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="receive-material-code" class="text-sm font-medium text-gray-700 mb-1">원료 코드</label>
                            <input type="text" id="receive-material-code" placeholder="원료 코드" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="receive-test-no" class="text-sm font-medium text-gray-700 mb-1">시험번호</label>
                            <input type="text" id="receive-test-no" placeholder="시험번호" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="receive-quantity" class="text-sm font-medium text-gray-700 mb-1">입고량</label>
                            <input type="text" id="receive-quantity" placeholder="입고량" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="receive-unit" class="text-sm font-medium text-gray-700 mb-1">단위 / 비중</label>
                            <div class="flex gap-2">
                                <select id="receive-unit" class="p-2 border rounded w-1/2" required></select>
                                <input type="number" id="receive-specific-gravity" placeholder="비중" step="0.01" class="p-2 border rounded w-1/2 hidden">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label for="receive-supplier" class="text-sm font-medium text-gray-700 mb-1">업체명</label>
                            <input type="text" id="receive-supplier" placeholder="업체명" class="p-2 border rounded">
                        </div>
                        <div class="flex flex-col">
                            <label for="receive-expiry-date" class="text-sm font-medium text-gray-700 mb-1">유통기한</label>
                            <input type="date" id="receive-expiry-date" class="p-2 border rounded" required>
                        </div>
                    </div>
                    <!-- Right Column: Remarks -->
                    <div class="lg:col-span-1 flex flex-col">
                        <label for="receive-remarks" class="text-sm font-medium text-gray-700 mb-1">비고</label>
                        <textarea id="receive-remarks" placeholder="비고" class="p-2 border rounded h-full flex-grow"></textarea>
                    </div>
                </div>
                <!-- Submit button below the grid -->
                <div class="mt-6">
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-300 w-full font-semibold">입고 등록</button>
                </div>
            </form>
        </div>

        <!-- 탭 메뉴 -->
        <div class="mb-8 no-print">
            <div class="flex border-b">
                <button id="tab-inventory" class="py-2 px-4 bg-white font-semibold text-blue-600 border-b-2 border-blue-600">실시간 재고 현황</button>
                <button id="tab-receiving" class="py-2 px-4 text-gray-500 font-semibold hover:text-blue-600">입고 내역</button>
                <button id="tab-issuing" class="py-2 px-4 text-gray-500 font-semibold hover:text-blue-600">출고 내역</button>
            </div>
        </div>

        <!-- 컨텐츠 영역 -->
        <div id="content-area">
            <!-- 실시간 재고 현황 -->
            <div id="inventory-content" class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <h3 class="text-xl font-bold">실시간 재고 현황</h3>
                    <input type="text" id="inventory-search" placeholder="원료명/코드 검색 (초성 가능)" class="p-2 border rounded w-full md:w-auto flex-grow no-print">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="table-cell text-center">번호</th>
                                <th class="table-cell text-center sortable" data-sort="name">원료명</th>
                                <th class="table-cell text-center sortable" data-sort="code">원료 코드</th>
                                <th class="table-cell text-center">현 재고</th>
                                <th class="table-cell text-center">유통기한</th>
                                <th class="table-cell text-center">잔여일</th>
                                <th class="table-cell text-center">비고</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- 입고 내역 -->
            <div id="receiving-content" class="bg-white p-6 rounded-lg shadow-lg hidden">
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <h3 class="text-xl font-bold">입고 내역</h3>
                    <input type="text" id="receiving-search" placeholder="원료명/코드/업체명 등 검색" class="p-2 border rounded w-full md:w-auto flex-grow no-print">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="table-cell text-center sortable" data-sort="date">입고일</th>
                                <th class="table-cell text-center sortable" data-sort="materialName">원료명</th>
                                <th class="table-cell text-center sortable" data-sort="materialCode">원료 코드</th>
                                <th class="table-cell text-center">시험번호</th>
                                <th class="table-cell text-center sortable" data-sort="quantity">입고량</th>
                                <th class="table-cell text-center sortable" data-sort="remainingStock">남은 재고</th>
                                <th class="table-cell text-center sortable" data-sort="supplier">업체명</th>
                                <th class="table-cell text-center sortable" data-sort="expiryDate">유통기한</th>
                                <th class="table-cell text-center sortable" data-sort="remainingDays">잔여일</th>
                                <th class="table-cell text-center">비고</th>
                                <th class="table-cell text-center no-print-col">작업</th>
                            </tr>
                        </thead>
                        <tbody id="receiving-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- 출고 내역 -->
            <div id="issuing-content" class="bg-white p-6 rounded-lg shadow-lg hidden">
                 <div class="flex flex-wrap gap-4 items-center mb-4">
                    <h3 class="text-xl font-bold">출고 내역</h3>
                    <input type="text" id="issuing-search" placeholder="원료명/코드/제품명 등 검색" class="p-2 border rounded w-full md:w-auto flex-grow no-print">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="table-cell text-center sortable" data-sort="date">출고일</th>
                                <th class="table-cell text-center sortable" data-sort="materialName">원료명</th>
                                <th class="table-cell text-center sortable" data-sort="materialCode">원료 코드</th>
                                <th class="table-cell text-center">시험번호</th>
                                <th class="table-cell text-center sortable" data-sort="quantity">출고량</th>
                                <th class="table-cell text-center sortable" data-sort="productName">제품명</th>
                                <th class="table-cell text-center">제조번호</th>
                                <th class="table-cell text-center">비고</th>
                            </tr>
                        </thead>
                        <tbody id="issuing-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 입고 수정 모달 -->
    <div id="edit-receiving-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="text-xl font-bold mb-4">입고 내역 수정</h3>
            <form id="edit-receiving-form" class="space-y-4">
                <input type="hidden" id="edit-receiving-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">입고일</label><input type="date" id="edit-receive-date" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">원료명</label><input type="text" id="edit-receive-material-name" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">원료 코드</label><input type="text" id="edit-receive-material-code" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">시험번호</label><input type="text" id="edit-receive-test-no" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">입고량</label><input type="text" id="edit-receive-quantity" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">단위 / 비중</label><div class="flex gap-2"><select id="edit-receive-unit" class="p-2 border rounded w-1/2" required></select><input type="number" id="edit-receive-specific-gravity" placeholder="비중" step="0.01" class="p-2 border rounded w-1/2 hidden"></div></div>
                    <div><label class="block text-sm font-medium">업체명</label><input type="text" id="edit-receive-supplier" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm font-medium">유통기한</label><input type="date" id="edit-receive-expiry-date" class="p-2 border rounded w-full" required></div>
                </div>
                <div><label class="block text-sm font-medium">비고</label><textarea id="edit-receive-remarks" class="p-2 border rounded w-full" rows="3"></textarea></div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-receiving" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700">수정 저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 출고 처리 모달 -->
    <div id="issue-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">원료 출고 처리</h3>
            <form id="issuing-form">
                <input type="hidden" id="issue-receiving-id">
                <div class="mb-4"><label class="block mb-1">원료명</label><p id="issue-modal-material-name" class="font-semibold"></p></div>
                <div class="mb-4"><label class="block mb-1">원료 코드</label><p id="issue-modal-material-code" class="font-semibold"></p></div>
                <div class="mb-4"><label class="block mb-1">해당 배치 재고</label><p id="issue-modal-batch-stock" class="font-semibold"></p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="date" id="issue-date" class="p-2 border rounded" required>
                    <div class="flex gap-2">
                        <input type="text" id="issue-quantity" placeholder="출고량" class="p-2 border rounded w-2/3" required>
                        <select id="issue-unit" class="p-2 border rounded w-1/3" required></select>
                    </div>
                    <input type="text" id="issue-test-no" placeholder="시험번호" class="p-2 border rounded" required>
                    <input type="text" id="issue-product-name" placeholder="제품명" class="p-2 border rounded">
                    <input type="text" id="issue-mfg-no" placeholder="제조번호" class="p-2 border rounded">
                    <textarea id="issue-remarks" placeholder="비고" class="p-2 border rounded md:col-span-2" rows="3"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-issue" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">출고 처리</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 재고 상세 정보 모달 -->
    <div id="detail-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="detail-modal-title" class="text-2xl font-bold">재고 상세 내역</h3>
                <button id="close-detail-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="mb-8">
                <h4 class="text-lg font-semibold mb-2 border-b pb-1">입고 내역</h4>
                <div class="overflow-x-auto max-h-60"><table class="w-full text-left border-collapse"><thead class="bg-gray-200 sticky top-0"><tr><th class="table-cell">입고일</th><th class="table-cell">시험번호</th><th class="table-cell">입고량</th><th class="table-cell">업체명</th><th class="table-cell">유통기한</th><th class="table-cell">비고</th></tr></thead><tbody id="detail-receiving-list"></tbody></table></div>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-2 border-b pb-1">출고 내역</h4>
                <div class="overflow-x-auto max-h-60"><table class="w-full text-left border-collapse"><thead class="bg-gray-200 sticky top-0"><tr><th class="table-cell">출고일</th><th class="table-cell">시험번호</th><th class="table-cell">출고량</th><th class="table-cell">제품명</th><th class="table-cell">제조번호</th><th class="table-cell">비고</th></tr></thead><tbody id="detail-issuing-list"></tbody></table></div>
            </div>
        </div>
    </div>
    
    <!-- 비밀번호 입력 모달 -->
    <div id="password-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="text-xl font-bold mb-4">비밀번호 입력</h3>
            <p class="text-gray-600 mb-4">파일을 저장하려면 비밀번호를 입력하세요.</p>
            <form id="password-form">
                <input type="password" id="password-input" class="p-2 border rounded w-full" placeholder="비밀번호" required>
                <div id="password-error" class="text-red-500 text-sm mt-2 hidden">비밀번호가 일치하지 않습니다.</div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-password" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-teal-600 text-white p-2 rounded hover:bg-teal-700">확인</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 비고 전체 보기 모달 -->
    <div id="remarks-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">비고 전체 내용</h3>
                <button id="close-remarks-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <p id="remarks-modal-content" class="text-gray-700 whitespace-pre-wrap bg-gray-100 p-4 rounded"></p>
        </div>
    </div>
    
    <!-- 비고 수정 모달 -->
    <div id="edit-remarks-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">비고 수정</h3>
            <form id="edit-remarks-form">
                <input type="hidden" id="edit-remarks-doc-id">
                <textarea id="edit-remarks-textarea" class="p-2 border rounded w-full" rows="5" required></textarea>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-remarks" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 단위 관리 모달 -->
    <div id="unit-management-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">단위 관리</h3>
                <button id="close-unit-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="unit-form" class="flex gap-2 mb-4">
                <input type="hidden" id="unit-id">
                <input type="text" id="unit-name" placeholder="단위명 (예: kg, L)" class="p-2 border rounded flex-grow" required>
                <button type="submit" id="submit-unit-btn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">추가</button>
                <button type="button" id="cancel-edit-unit-btn" class="bg-gray-500 text-white px-4 rounded hover:bg-gray-600 hidden">취소</button>
            </form>
            <div>
                <h4 class="text-lg font-semibold mb-2">등록된 단위 목록</h4>
                <ul id="unit-list-management" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Unit items will be populated here -->
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports and config
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAMKGrBLshg6lpO0pCtp7jdIhiCjAmM1WQ",
            authDomain: "management-raw.firebaseapp.com",
            projectId: "management-raw",
            storageBucket: "management-raw.appspot.com",
            messagingSenderId: "697218209723",
            appId: "1:697218209723:web:30c6baadc3713ececd569e"
        };

        // --- 아래 코드는 수정할 필요 없습니다. ---
        let app, db, auth, userId, appId;
        let receivingCollection, issuingCollection, unitsCollection;
        let globalReceivingData = [], globalIssuingData = [], globalUnitsData = [];
        let sortState = {};
        let isDbReady = false;
        let currentAction = { type: null, id: null };

        try {
            const configToUse = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}'
                ? JSON.parse(__firebase_config)
                : firebaseConfig;

            if (!configToUse.apiKey) {
                 throw new Error("Firebase config is not provided. Please add your config object in the code.");
            }
            
            appId = typeof __app_id !== 'undefined' ? __app_id : configToUse.projectId || 'default-app-id';
            app = initializeApp(configToUse);
            db = getFirestore(app);
            auth = getAuth(app);
            isDbReady = true;

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    initializeCollections();
                    loadAndRenderData();
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        isDbReady = false;
                    });
                }
            });

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.addEventListener('DOMContentLoaded', () => {
                const errorBanner = document.createElement('div');
                errorBanner.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 no-print';
                errorBanner.setAttribute('role', 'alert');
                errorBanner.innerHTML = `<p class="font-bold">데이터베이스 연결 실패</p><p>Firebase 설정이 올바르지 않습니다. 코드 상단의 firebaseConfig 부분을 확인하고 자신의 설정으로 교체해주세요.</p>`;
                const appDiv = document.getElementById('app');
                if (appDiv) appDiv.prepend(errorBanner);
            });
        }
        
        // --- UI Elements ---
        const editReceivingModal = document.getElementById('edit-receiving-modal');
        const editReceivingForm = document.getElementById('edit-receiving-form');
        const cancelEditReceivingBtn = document.getElementById('cancel-edit-receiving');
        const editRemarksModal = document.getElementById('edit-remarks-modal');
        const editRemarksForm = document.getElementById('edit-remarks-form');
        const cancelEditRemarksBtn = document.getElementById('cancel-edit-remarks');
        // Other elements...
        const manageUnitsBtn = document.getElementById('manage-units-btn');
        const unitManagementModal = document.getElementById('unit-management-modal');
        const closeUnitModalBtn = document.getElementById('close-unit-modal');
        const unitForm = document.getElementById('unit-form');
        const unitIdInput = document.getElementById('unit-id');
        const unitNameInput = document.getElementById('unit-name');
        const submitUnitBtn = document.getElementById('submit-unit-btn');
        const cancelEditUnitBtn = document.getElementById('cancel-edit-unit-btn');
        const unitListManagement = document.getElementById('unit-list-management');
        const receiveUnitSelect = document.getElementById('receive-unit');
        const issueUnitSelect = document.getElementById('issue-unit');
        const receiveQuantityInput = document.getElementById('receive-quantity');
        const issueQuantityInput = document.getElementById('issue-quantity');
        const receiveSpecificGravityInput = document.getElementById('receive-specific-gravity');
        const printBtn = document.getElementById('print-btn');
        const saveBtn = document.getElementById('save-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const cancelPasswordBtn = document.getElementById('cancel-password');
        const receivingForm = document.getElementById('receiving-form');
        const issuingForm = document.getElementById('issuing-form');
        const receivingList = document.getElementById('receiving-list');
        const issuingList = document.getElementById('issuing-list');
        const inventoryList = document.getElementById('inventory-list');
        const issueModal = document.getElementById('issue-modal');
        const detailModal = document.getElementById('detail-modal');
        const cancelIssueBtn = document.getElementById('cancel-issue');
        const closeDetailModalBtn = document.getElementById('close-detail-modal');
        const remarksModal = document.getElementById('remarks-modal');
        const closeRemarksModalBtn = document.getElementById('close-remarks-modal');
        const remarksModalContent = document.getElementById('remarks-modal-content');
        const searchInputs = {
            inventory: document.getElementById('inventory-search'),
            receiving: document.getElementById('receiving-search'),
            issuing: document.getElementById('issuing-search'),
        };

        // --- Formatting Utility ---
        function formatNumber(num) {
            if (num === null || num === undefined) return '';
            return Number(num).toLocaleString('en-US');
        }

        function formatNumberInput(e) {
            const input = e.target;
            let value = input.value;
            const originalValue = value.replace(/,/g, '');
            
            if (isNaN(originalValue) || originalValue.trim() === '') {
                input.value = '';
            } else {
                const formattedValue = formatNumber(originalValue);
                input.value = formattedValue;
            }
        }

        function parseFormattedNumber(value) {
            return Number(String(value).replace(/,/g, ''));
        }

        // --- 초성 검색 유틸리티 ---
        const CHO = "ㄱㄲㄴㄷㄸㄹㅁㅂㅃㅅㅆㅇㅈㅉㅊㅋㅌㅍㅎ";
        const isKorean = (char) => char.match(/[ㄱ-ㅎ가-힣]/);
        const getChosung = (char) => {
            if (!isKorean(char)) return char;
            const code = char.charCodeAt(0) - 44032;
            if (code < 0) return char;
            return CHO[Math.floor(code / 588)];
        };
        const chosungMatch = (str, search) => {
            if (!search) return true;
            str = String(str).toLowerCase();
            search = search.toLowerCase();
            if (!isKorean(search.charAt(0))) return str.includes(search);
            let searchChosung = "";
            for (let i = 0; i < search.length; i++) searchChosung += getChosung(search[i]);
            let strChosung = "";
            for (let i = 0; i < str.length; i++) strChosung += getChosung(str[i]);
            return strChosung.includes(searchChosung);
        };
        
        // --- Notification Utility ---
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white z-2000 ${isError ? 'bg-red-500' : 'bg-blue-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function initializeCollections() {
            if (!userId || !isDbReady) return;
            const userPath = `artifacts/${appId}/users/${userId}`;
            receivingCollection = collection(db, `${userPath}/receiving`);
            issuingCollection = collection(db, `${userPath}/issuing`);
            unitsCollection = collection(db, `${userPath}/units`);
        }

        // --- Data Processing ---
        function processAndRenderAll() {
            renderInventory();
            renderReceivingList();
            renderIssuingList();
        }

        function getFilteredAndSortedData(data, searchInput, sortKey, fieldsToSearch) {
            const searchTerm = searchInput.value;
            const filtered = data.filter(item => {
                if (!searchTerm) return true;
                return fieldsToSearch.some(field => chosungMatch(item[field], searchTerm));
            });
            if (sortState[sortKey] && sortState[sortKey].key) {
                const { key, direction } = sortState[sortKey];
                filtered.sort((a, b) => {
                    let valA = a[key], valB = b[key];
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            return filtered;
        }

        // --- Data Loading and Rendering ---
        function loadAndRenderData() {
            if (!userId || !isDbReady) return;
            
            // Load Units first
            onSnapshot(unitsCollection, (unitSnapshot) => {
                globalUnitsData = unitSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUnitManagementList();
                populateUnitDropdowns();
            });

            // Load main data
            onSnapshot(receivingCollection, (receivingSnapshot) => {
                globalReceivingData = receivingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                onSnapshot(issuingCollection, (issuingSnapshot) => {
                    globalIssuingData = issuingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    processAndRenderAll();
                });
            });
        }

        function renderInventory() {
            const inventory = {};
            const issuedQtys = {};
            globalIssuingData.forEach(issue => {
                issuedQtys[issue.receivingId] = (issuedQtys[issue.receivingId] || 0) + parseFormattedNumber(issue.quantity);
            });

            globalReceivingData.forEach(item => {
                const key = `${item.materialName}_${item.materialCode}`;
                if (!inventory[key]) {
                    inventory[key] = { name: item.materialName, code: item.materialCode, stock: {}, batches: [] };
                }
                const remainingStock = parseFormattedNumber(item.quantity) - (issuedQtys[item.id] || 0);
                if (remainingStock > 0) {
                    inventory[key].batches.push({ ...item, remainingStock });
                }
            });

            let inventoryData = Object.values(inventory).map(item => {
                const stockByUnit = {};
                let earliestExpiryDate = null;
                let earliestBatch = null;

                item.batches.forEach(batch => {
                    const unit = batch.unit || 'N/A';
                    if (!stockByUnit[unit]) {
                        stockByUnit[unit] = 0;
                    }
                    stockByUnit[unit] += batch.remainingStock;

                    if (!earliestExpiryDate || new Date(batch.expiryDate) < new Date(earliestExpiryDate)) {
                        earliestExpiryDate = batch.expiryDate;
                        earliestBatch = batch;
                    }
                });

                const stockStrings = Object.entries(stockByUnit).map(([unit, qty]) => `${formatNumber(qty)} ${unit}`).join(', ');
                
                return { 
                    name: item.name, 
                    code: item.code, 
                    currentStockStr: stockStrings, 
                    earliestExpiryDate: earliestBatch ? earliestBatch.expiryDate : '',
                    remainingDays: earliestBatch ? Math.ceil((new Date(earliestBatch.expiryDate) - new Date()) / (1000 * 60 * 60 * 24)) : '',
                    remarks: earliestBatch ? earliestBatch.remarks : '',
                    remarksDocId: earliestBatch ? earliestBatch.id : null
                };
            }).filter(item => item.currentStockStr !== ''); // Filter out items with no stock

            const processedData = getFilteredAndSortedData(inventoryData, searchInputs.inventory, 'inventory', ['name', 'code']);
            
            inventoryList.innerHTML = '';
            processedData.forEach((item, index) => {
                const remarksCell = createRemarksCell(item.remarks, item.remarksDocId);
                const row = inventoryList.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.dataset.name = item.name;
                row.dataset.code = item.code;
                row.innerHTML = `
                    <td class="table-cell text-center">${index + 1}</td>
                    <td class="table-cell font-medium">${item.name}</td>
                    <td class="table-cell">${item.code}</td>
                    <td class="table-cell font-bold">${item.currentStockStr || '0'}</td>
                    <td class="table-cell">${item.earliestExpiryDate}</td>
                    <td class="table-cell ${item.remainingDays < 30 ? 'text-red-500 font-bold' : ''}">${item.remainingDays >= 0 ? `${item.remainingDays}일` : '만료'}</td>
                    ${remarksCell}
                `;
            });
        }


        function renderReceivingList() {
            const issuedQtys = {};
            globalIssuingData.forEach(issue => {
                issuedQtys[issue.receivingId] = (issuedQtys[issue.receivingId] || 0) + parseFormattedNumber(issue.quantity);
            });
            let receivingData = globalReceivingData.map(item => { const remainingStock = parseFormattedNumber(item.quantity) - (issuedQtys[item.id] || 0); const expiryDate = new Date(item.expiryDate); const today = new Date(); today.setHours(0,0,0,0); const remainingDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24)); return { ...item, remainingStock, remainingDays }; });
            const processedData = getFilteredAndSortedData(receivingData, searchInputs.receiving, 'receiving', ['date', 'materialName', 'materialCode', 'testNo', 'supplier']);
            receivingList.innerHTML = '';
            processedData.forEach(item => {
                const remarksCell = createRemarksCell(item.remarks);
                const quantityCell = createQuantityCell(item.quantity, item.unit, item.specificGravity);
                const remainingStockCell = createQuantityCell(item.remainingStock, item.unit, item.specificGravity);
                const isIssued = globalIssuingData.some(issue => issue.receivingId === item.id);

                const row = receivingList.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `<td class="table-cell">${item.date}</td><td class="table-cell font-medium">${item.materialName}</td><td class="table-cell">${item.materialCode}</td><td class="table-cell">${item.testNo}</td>${quantityCell}${remainingStockCell}<td class="table-cell">${item.supplier}</td><td class="table-cell">${item.expiryDate}</td><td class="table-cell ${item.remainingDays < 30 ? 'text-red-500 font-bold' : ''}">${item.remainingDays >= 0 ? `${item.remainingDays}일` : '만료'}</td>${remarksCell}
                <td class="table-cell no-print-col text-center space-x-2">
                    <button data-id="${item.id}" data-name="${item.materialName}" data-code="${item.materialCode}" data-stock="${item.remainingStock}" data-unit="${item.unit || ''}" class="issue-btn text-sm bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 disabled:bg-gray-400" ${item.remainingStock <= 0 ? 'disabled' : ''}>출고</button>
                    <button data-id="${item.id}" class="edit-btn text-sm bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 disabled:bg-gray-400" ${isIssued ? 'disabled title="출고된 내역은 수정할 수 없습니다."' : ''}>수정</button>
                    <button data-id="${item.id}" class="delete-btn text-sm bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 disabled:bg-gray-400" ${isIssued ? 'disabled title="출고된 내역은 삭제할 수 없습니다."' : ''}>삭제</button>
                </td>`;
            });
        }

        function renderIssuingList() {
            const processedData = getFilteredAndSortedData(globalIssuingData, searchInputs.issuing, 'issuing', ['date', 'materialName', 'materialCode', 'testNo', 'productName']);
            issuingList.innerHTML = '';
            processedData.forEach(item => {
                const receivingDoc = globalReceivingData.find(r => r.id === item.receivingId);
                const sg = receivingDoc ? receivingDoc.specificGravity : 1;
                const quantityCell = createQuantityCell(item.quantity, item.unit, sg);
                const remarksCell = createRemarksCell(item.remarks);
                const row = issuingList.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `<td class="table-cell">${item.date}</td><td class="table-cell font-medium">${item.materialName}</td><td class="table-cell">${item.materialCode}</td><td class="table-cell">${item.testNo}</td>${quantityCell}<td class="table-cell">${item.productName}</td><td class="table-cell">${item.mfgNo}</td>${remarksCell}`;
            });
        }
        
        function createRemarksCell(remarks, docId = null) {
            const maxLength = 15;
            let content = remarks || '';
            let classes = 'table-cell';
            let title = '';
            let dataAttributes = `data-full-remarks="${remarks || ''}"`;

            if (remarks && remarks.length > maxLength) {
                content = `${remarks.substring(0, maxLength)}...`;
                classes += ' remarks-cell text-blue-600 font-semibold';
                title = '클릭하여 전체 보기';
            }
            
            let editButton = '';
            if (docId) {
                editButton = `<button class="edit-remark-btn ml-2 text-gray-400 hover:text-gray-700 no-print" data-doc-id="${docId}">✏️</button>`;
            }

            return `<td class="${classes}" title="${title}" ${dataAttributes}>${content}${editButton}</td>`;
        }
        
        function createQuantityCell(originalQuantity, originalUnit, specificGravity = 1) {
            const unitLower = (originalUnit || '').toLowerCase();
            const isVolume = unitLower === 'l' || unitLower === 'ml';

            if (isVolume) {
                let convertedKg = 0;
                if (unitLower === 'l') {
                    convertedKg = originalQuantity * specificGravity;
                } else if (unitLower === 'ml') {
                    convertedKg = (originalQuantity * specificGravity) / 1000;
                }
                
                const originalText = `${formatNumber(originalQuantity)} ${originalUnit} (비중: ${specificGravity})`;
                const convertedText = `${formatNumber(convertedKg.toFixed(2))} KG`;

                return `<td class="table-cell">
                            <span class="converted-value" 
                                  data-original-text="${originalText}" 
                                  data-converted-text="${convertedText}"
                                  title="클릭하여 단위 전환">
                                ${convertedText}
                            </span>
                        </td>`;
            } else {
                return `<td class="table-cell">${formatNumber(originalQuantity)} ${originalUnit || ''}</td>`;
            }
        }
        
        function renderUnitManagementList() {
            unitListManagement.innerHTML = '';
            globalUnitsData.forEach(unit => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-gray-100 rounded';
                li.innerHTML = `
                    <span>${unit.name}</span>
                    <div class="space-x-2">
                        <button data-id="${unit.id}" data-name="${unit.name}" class="edit-unit-btn text-blue-500 hover:text-blue-700">편집</button>
                        <button data-id="${unit.id}" class="delete-unit-btn text-red-500 hover:text-red-700">삭제</button>
                    </div>
                `;
                unitListManagement.appendChild(li);
            });
        }

        function populateUnitDropdowns() {
            const options = globalUnitsData.map(unit => `<option value="${unit.name}">${unit.name}</option>`).join('');
            receiveUnitSelect.innerHTML = options;
            issueUnitSelect.innerHTML = options;
            document.getElementById('edit-receive-unit').innerHTML = options;
            // After populating, check the initial state for the specific gravity input
            toggleSpecificGravityInput(receiveUnitSelect, receiveSpecificGravityInput);
        }
        
        function toggleSpecificGravityInput(selectElement = receiveUnitSelect, inputElement = receiveSpecificGravityInput) {
            const selectedUnit = selectElement.value.toLowerCase();
            if (selectedUnit === 'l' || selectedUnit === 'ml') {
                inputElement.classList.remove('hidden');
            } else {
                inputElement.classList.add('hidden');
            }
        }

        // --- Event Handlers ---
        document.addEventListener('DOMContentLoaded', () => {
             setupEventListeners();
        });

        function setupEventListeners() {
            // Number formatting
            receiveQuantityInput.addEventListener('input', formatNumberInput);
            issueQuantityInput.addEventListener('input', formatNumberInput);
            document.getElementById('edit-receive-quantity').addEventListener('input', formatNumberInput);

            // Unit select change
            receiveUnitSelect.addEventListener('change', () => toggleSpecificGravityInput(receiveUnitSelect, receiveSpecificGravityInput));
            document.getElementById('edit-receive-unit').addEventListener('change', (e) => toggleSpecificGravityInput(e.target, document.getElementById('edit-receive-specific-gravity')));

            // New Unit Management Listeners
            manageUnitsBtn.addEventListener('click', () => unitManagementModal.classList.remove('hidden'));
            closeUnitModalBtn.addEventListener('click', () => unitManagementModal.classList.add('hidden'));
            unitForm.addEventListener('submit', handleUnitFormSubmit);
            cancelEditUnitBtn.addEventListener('click', cancelUnitEdit);
            unitListManagement.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-unit-btn')) {
                    handleDeleteUnit(e.target.dataset.id);
                } else if (e.target.classList.contains('edit-unit-btn')) {
                    handleEditUnit(e.target.dataset.id, e.target.dataset.name);
                }
            });

            // Edit/Delete Listeners
            receivingList.addEventListener('click', (e) => {
                if (e.target.classList.contains('issue-btn')) {
                    openIssueModal(e);
                } else if (e.target.classList.contains('edit-btn')) {
                    handleEditClick(e.target.dataset.id);
                } else if (e.target.classList.contains('delete-btn')) {
                    handleDeleteClick(e.target.dataset.id);
                }
            });
            editReceivingForm.addEventListener('submit', handleEditReceivingSubmit);
            cancelEditReceivingBtn.addEventListener('click', () => editReceivingModal.classList.add('hidden'));
            
            // Remark Edit Modal Listeners
            editRemarksForm.addEventListener('submit', handleEditRemarksSubmit);
            cancelEditRemarksBtn.addEventListener('click', () => editRemarksModal.classList.add('hidden'));

            // Existing Listeners
            printBtn.addEventListener('click', () => window.print());
            saveBtn.addEventListener('click', () => {
                currentAction.type = 'save';
                passwordModal.classList.remove('hidden');
                passwordInput.focus();
            });
            cancelPasswordBtn.addEventListener('click', closePasswordModal);
            passwordForm.addEventListener('submit', handlePasswordSubmit);
            receivingForm.addEventListener('submit', handleReceivingSubmit);
            issuingForm.addEventListener('submit', handleIssuingSubmit);
            inventoryList.addEventListener('click', (e) => handleDetailClick(e));
            Object.values(searchInputs).forEach(input => input.addEventListener('input', processAndRenderAll));
            document.querySelectorAll('.sortable').forEach(header => header.addEventListener('click', handleSortClick));
            cancelIssueBtn.addEventListener('click', closeIssueModal);
            closeDetailModalBtn.addEventListener('click', closeDetailModal);
            closeRemarksModalBtn.addEventListener('click', closeRemarksModal);
            document.querySelectorAll('#app button[id^="tab-"]').forEach(tab => tab.addEventListener('click', handleTabClick));
            document.getElementById('content-area').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-remark-btn')) {
                    e.stopPropagation(); // Prevent other click events on the cell
                    handleEditRemarkClick(e.target.dataset.docId);
                } else if (e.target.classList.contains('remarks-cell')) {
                    const fullRemarks = e.target.dataset.fullRemarks;
                    openRemarksModal(fullRemarks);
                } else if (e.target.classList.contains('converted-value')) {
                    const el = e.target;
                    const originalText = el.dataset.originalText;
                    const convertedText = el.dataset.convertedText;
                    if (el.textContent.trim() === convertedText) {
                        el.textContent = originalText;
                    } else {
                        el.textContent = convertedText;
                    }
                }
            });
        }

        async function handleUnitFormSubmit(e) {
            e.preventDefault();
            if (!isDbReady || !userId) {
                showNotification('데이터베이스에 연결되지 않아 저장할 수 없습니다.', true);
                return;
            }
            const id = unitIdInput.value;
            const name = unitNameInput.value.trim();
            if (!name) return;

            try {
                if (id) { // Update
                    const unitRef = doc(unitsCollection, id);
                    await updateDoc(unitRef, { name });
                    showNotification('단위가 수정되었습니다.');
                } else { // Add
                    await addDoc(unitsCollection, { name });
                    showNotification('단위가 추가되었습니다.');
                }
                cancelUnitEdit();
            } catch (error) {
                console.error("Error saving unit:", error);
                showNotification('단위 저장에 실패했습니다.', true);
            }
        }

        function cancelUnitEdit() {
            unitIdInput.value = '';
            unitNameInput.value = '';
            submitUnitBtn.textContent = '추가';
            submitUnitBtn.classList.replace('bg-green-600', 'bg-blue-600');
            cancelEditUnitBtn.classList.add('hidden');
        }

        function handleEditUnit(id, name) {
            unitIdInput.value = id;
            unitNameInput.value = name;
            submitUnitBtn.textContent = '수정';
            submitUnitBtn.classList.replace('bg-blue-600', 'bg-green-600');
            cancelEditUnitBtn.classList.remove('hidden');
            unitNameInput.focus();
        }

        async function handleDeleteUnit(id) {
            if (confirm('이 단위를 삭제하시겠습니까? 이 단위를 사용한 기존 데이터에는 영향을 주지 않습니다.')) {
                 if (!isDbReady || !userId) {
                    showNotification('데이터베이스에 연결되지 않아 삭제할 수 없습니다.', true);
                    return;
                }
                try {
                    const unitRef = doc(unitsCollection, id);
                    await deleteDoc(unitRef);
                    showNotification('단위가 삭제되었습니다.');
                } catch (error) {
                    console.error("Error deleting unit:", error);
                    showNotification('단위 삭제에 실패했습니다.', true);
                }
            }
        }
        
        function handleEditClick(id) {
            currentAction = { type: 'edit', id: id };
            passwordModal.classList.remove('hidden');
            passwordInput.focus();
        }

        function handleDeleteClick(id) {
            currentAction = { type: 'delete', id: id };
            passwordModal.classList.remove('hidden');
            passwordInput.focus();
        }

        function handlePasswordSubmit(e) {
            e.preventDefault();
            if (passwordInput.value === '0000') {
                if (currentAction.type === 'edit') {
                    openEditModal(currentAction.id);
                } else if (currentAction.type === 'delete') {
                    performDelete(currentAction.id);
                } else if (currentAction.type === 'save') {
                    generateAndDownloadExcel();
                }
                closePasswordModal();
            } else {
                passwordError.classList.remove('hidden');
            }
        }

        function openEditModal(id) {
            const item = globalReceivingData.find(d => d.id === id);
            if (!item) return;

            document.getElementById('edit-receiving-id').value = id;
            document.getElementById('edit-receive-date').value = item.date;
            document.getElementById('edit-receive-material-name').value = item.materialName;
            document.getElementById('edit-receive-material-code').value = item.materialCode;
            document.getElementById('edit-receive-test-no').value = item.testNo;
            document.getElementById('edit-receive-quantity').value = formatNumber(item.quantity);
            document.getElementById('edit-receive-unit').value = item.unit;
            document.getElementById('edit-receive-supplier').value = item.supplier;
            document.getElementById('edit-receive-expiry-date').value = item.expiryDate;
            document.getElementById('edit-receive-remarks').value = item.remarks;
            
            const sgInput = document.getElementById('edit-receive-specific-gravity');
            const unitSelect = document.getElementById('edit-receive-unit');
            toggleSpecificGravityInput(unitSelect, sgInput);
            if ((item.unit || '').toLowerCase() === 'l' || (item.unit || '').toLowerCase() === 'ml') {
                sgInput.value = item.specificGravity;
            }

            editReceivingModal.classList.remove('hidden');
        }

        async function handleEditReceivingSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-receiving-id').value;
            const unit = document.getElementById('edit-receive-unit').value;
            const specificGravity = (unit.toLowerCase() === 'l' || unit.toLowerCase() === 'ml')
                ? parseFloat(document.getElementById('edit-receive-specific-gravity').value) || 1
                : 1;

            const updatedData = {
                date: document.getElementById('edit-receive-date').value,
                materialName: document.getElementById('edit-receive-material-name').value,
                materialCode: document.getElementById('edit-receive-material-code').value,
                testNo: document.getElementById('edit-receive-test-no').value,
                quantity: parseFormattedNumber(document.getElementById('edit-receive-quantity').value),
                unit: unit,
                specificGravity: specificGravity,
                supplier: document.getElementById('edit-receive-supplier').value,
                expiryDate: document.getElementById('edit-receive-expiry-date').value,
                remarks: document.getElementById('edit-receive-remarks').value,
            };

            try {
                const docRef = doc(receivingCollection, id);
                await updateDoc(docRef, updatedData);
                editReceivingModal.classList.add('hidden');
                showNotification('입고 내역이 수정되었습니다.');
            } catch (error) {
                console.error("Error updating document:", error);
                showNotification('수정에 실패했습니다.', true);
            }
        }

        async function performDelete(id) {
            if (confirm('정말로 이 입고 내역을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                try {
                    const docRef = doc(receivingCollection, id);
                    await deleteDoc(docRef);
                    showNotification('입고 내역이 삭제되었습니다.');
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showNotification('삭제에 실패했습니다.', true);
                }
            }
        }


        function handleSortClick(e) {
            const header = e.currentTarget;
            const sortKey = header.closest('div[id$="-content"]').id.replace('-content', '');
            const key = header.dataset.sort;
            document.querySelectorAll(`#${sortKey}-content .sortable`).forEach(h => { if (h !== header) h.className = 'table-cell sortable'; });
            if (sortState[sortKey]?.key === key && sortState[sortKey]?.direction === 'asc') { sortState[sortKey].direction = 'desc'; header.className = 'table-cell sortable desc'; } else { sortState[sortKey] = { key, direction: 'asc' }; header.className = 'table-cell sortable asc'; }
            processAndRenderAll();
        }

        function handleTabClick(e) {
            const tabId = e.target.id;
            const contentId = tabId.replace('tab-', '') + '-content';
            document.querySelectorAll('#app button[id^="tab-"]').forEach(t => {
                t.classList.remove('text-blue-600', 'border-blue-600', 'bg-white');
                t.classList.add('text-gray-500');
            });
            e.target.classList.add('text-blue-600', 'border-blue-600', 'bg-white');
            e.target.classList.remove('text-gray-500');
            document.querySelectorAll('#content-area > div').forEach(c => c.classList.add('hidden'));
            document.getElementById(contentId).classList.remove('hidden');
        }

        async function handleReceivingSubmit(e) {
            e.preventDefault();
            if (!isDbReady || !userId) {
                showNotification('데이터베이스에 연결되지 않아 저장할 수 없습니다.', true);
                return;
            }
            const unit = receiveUnitSelect.value;
            const specificGravity = (unit.toLowerCase() === 'l' || unit.toLowerCase() === 'ml')
                ? parseFloat(receiveSpecificGravityInput.value) || 1
                : 1;
            const newReceiving = { date: document.getElementById('receive-date').value, materialName: document.getElementById('receive-material-name').value, materialCode: document.getElementById('receive-material-code').value, testNo: document.getElementById('receive-test-no').value, quantity: parseFormattedNumber(receiveQuantityInput.value), unit: unit, specificGravity: specificGravity, supplier: document.getElementById('receive-supplier').value, expiryDate: document.getElementById('receive-expiry-date').value, remarks: document.getElementById('receive-remarks').value, createdAt: new Date(), };
            try {
                await addDoc(receivingCollection, newReceiving);
                receivingForm.reset();
                toggleSpecificGravityInput(); // Reset the visibility after submission
                showNotification('입고 정보가 성공적으로 저장되었습니다.');
            } catch (error) { console.error("Error adding document: ", error); showNotification('저장에 실패했습니다.', true); }
        }
        async function handleIssuingSubmit(e) {
            e.preventDefault();
            if (!isDbReady || !userId) {
                showNotification('데이터베이스에 연결되지 않아 저장할 수 없습니다.', true);
                return;
            }
            const receivingId = document.getElementById('issue-receiving-id').value;
            const issueQuantity = parseFormattedNumber(issueQuantityInput.value);
            const batchStock = parseFormattedNumber(document.getElementById('issue-modal-batch-stock').dataset.rawStock);
            if (issueQuantity > batchStock) {
                showNotification('출고량이 해당 배치의 재고보다 많을 수 없습니다.', true);
                return;
            }
            const receivingDocRef = doc(db, `artifacts/${appId}/users/${userId}/receiving`, receivingId);
            const receivingDocSnap = await getDoc(receivingDocRef);
            if (!receivingDocSnap.exists()) {
                showNotification('출고할 입고 정보를 찾을 수 없습니다.', true);
                return;
            }
            const receivingData = receivingDocSnap.data();
            const newIssuing = { date: document.getElementById('issue-date').value, quantity: issueQuantity, unit: document.getElementById('issue-unit').value, testNo: document.getElementById('issue-test-no').value, productName: document.getElementById('issue-product-name').value, mfgNo: document.getElementById('issue-mfg-no').value, remarks: document.getElementById('issue-remarks').value, receivingId: receivingId, materialName: receivingData.materialName, materialCode: receivingData.materialCode, createdAt: new Date(), };
            try {
                await addDoc(issuingCollection, newIssuing);
                closeIssueModal();
                showNotification('출고 처리되었습니다.');
            } catch (error) { console.error("Error adding document: ", error); showNotification('출고 처리에 실패했습니다.', true); }
        }
        
        function handleDetailClick(e) {
            const row = e.target.closest('tr');
            if (e.target.classList.contains('remarks-cell') || e.target.classList.contains('converted-value') || e.target.closest('.no-print-col')) return; 
            if (!row || !row.dataset.name) return;
            openDetailModal(row.dataset.name, row.dataset.code);
        }

        // --- Modal Control ---
        function closePasswordModal() { passwordModal.classList.add('hidden'); passwordInput.value = ''; passwordError.classList.add('hidden'); currentAction = { type: null, id: null }; }
        function openIssueModal(e) {
            e.stopPropagation();
            const button = e.target;
            const batchStockElement = document.getElementById('issue-modal-batch-stock');
            batchStockElement.textContent = `${formatNumber(button.dataset.stock)} ${button.dataset.unit || ''}`;
            batchStockElement.dataset.rawStock = button.dataset.stock;
            document.getElementById('issue-receiving-id').value = button.dataset.id;
            document.getElementById('issue-modal-material-name').textContent = button.dataset.name;
            document.getElementById('issue-modal-material-code').textContent = button.dataset.code;
            issueQuantityInput.max = button.dataset.stock;
            document.getElementById('issue-date').valueAsDate = new Date();
            issueUnitSelect.value = button.dataset.unit || (globalUnitsData.length > 0 ? globalUnitsData[0].name : '');
            issueModal.classList.remove('hidden');
        }
        function closeIssueModal() { issuingForm.reset(); issueQuantityInput.value = ''; issueModal.classList.add('hidden'); }
        function openDetailModal(materialName, materialCode) {
            document.getElementById('detail-modal-title').textContent = `[${materialName} (${materialCode})] 상세 내역`;
            const filteredReceiving = globalReceivingData.filter(item => item.materialName === materialName && item.materialCode === materialCode).sort((a,b) => b.date.localeCompare(a.date));
            const filteredIssuing = globalIssuingData.filter(item => item.materialName === materialName && item.materialCode === materialCode).sort((a,b) => b.date.localeCompare(a.date));
            const detailReceivingList = document.getElementById('detail-receiving-list');
            detailReceivingList.innerHTML = '';
            filteredReceiving.forEach(item => { const row = detailReceivingList.insertRow(); row.className = 'border-b'; row.innerHTML = `<td class="table-cell">${item.date}</td><td class="table-cell">${item.testNo}</td>${createQuantityCell(item.quantity, item.unit, item.specificGravity)}<td class="table-cell">${item.supplier}</td><td class="table-cell">${item.expiryDate}</td><td class="table-cell remarks-cell" data-full-remarks="${item.remarks || ''}">${(item.remarks || '').substring(0,15)}...</td>`; });
            const detailIssuingList = document.getElementById('detail-issuing-list');
            detailIssuingList.innerHTML = '';
            filteredIssuing.forEach(item => { 
                const receivingDoc = globalReceivingData.find(r => r.id === item.receivingId);
                const sg = receivingDoc ? receivingDoc.specificGravity : 1;
                const row = detailIssuingList.insertRow(); row.className = 'border-b'; row.innerHTML = `<td class="table-cell">${item.date}</td><td class="table-cell">${item.testNo}</td>${createQuantityCell(item.quantity, item.unit, sg)}<td class="table-cell">${item.productName}</td><td class="table-cell">${item.mfgNo}</td><td class="table-cell remarks-cell" data-full-remarks="${item.remarks || ''}">${(item.remarks || '').substring(0,15)}...</td>`; });
            detailModal.classList.remove('hidden');
        }
        function closeDetailModal() { detailModal.classList.add('hidden'); }
        function openRemarksModal(text) { remarksModalContent.textContent = text; remarksModal.classList.remove('hidden'); }
        function closeRemarksModal() { remarksModal.classList.add('hidden'); }
        async function handleEditRemarkClick(docId) {
            const docRef = doc(receivingCollection, docId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                showNotification('해당 데이터를 찾을 수 없습니다.', true);
                return;
            }
            const currentRemark = docSnap.data().remarks || '';
            document.getElementById('edit-remarks-doc-id').value = docId;
            document.getElementById('edit-remarks-textarea').value = currentRemark;
            editRemarksModal.classList.remove('hidden');
        }
        
        async function handleEditRemarksSubmit(e) {
            e.preventDefault();
            const docId = document.getElementById('edit-remarks-doc-id').value;
            const newRemark = document.getElementById('edit-remarks-textarea').value;
            
            if (!docId) {
                showNotification('오류: 문서 ID를 찾을 수 없습니다.', true);
                return;
            }

            try {
                const docRef = doc(receivingCollection, docId);
                await updateDoc(docRef, { remarks: newRemark });
                editRemarksModal.classList.add('hidden');
                showNotification('비고가 수정되었습니다.');
            } catch (error) {
                console.error("Error updating remark:", error);
                showNotification('비고 수정에 실패했습니다.', true);
            }
        }

        // --- Excel Export Function ---
        function generateAndDownloadExcel() {
             const inventory = {};
            [...globalReceivingData, ...globalIssuingData].forEach(item => {
                const key = `${item.materialName}_${item.materialCode}`;
                if (!inventory[key]) {
                    inventory[key] = { name: item.materialName, code: item.materialCode, stock: {} };
                }
                const unit = item.unit || 'N/A';
                if (!inventory[key].stock[unit]) {
                    inventory[key].stock[unit] = { received: 0, issued: 0 };
                }
                const quantity = parseFormattedNumber(item.quantity);
                if (item.createdAt) {
                     if (item.supplier !== undefined) {
                        inventory[key].stock[unit].received += quantity;
                    } else {
                        inventory[key].stock[unit].issued += quantity;
                    }
                }
            });
            const inventoryData = Object.values(inventory).map(item => {
                const stockStrings = Object.entries(item.stock).map(([unit, values]) => `${values.received - values.issued} ${unit}`).join(', ');
                 const materialReceivingBatches = globalReceivingData.filter(r => r.materialName === item.name && r.materialCode === item.code);
                let totalConvertedKg = 0;
                materialReceivingBatches.forEach(batch => {
                    const issuedQtyForThisBatch = globalIssuingData.filter(issue => issue.receivingId === batch.id).reduce((sum, issue) => sum + parseFormattedNumber(issue.quantity), 0);
                    const remainingQty = parseFormattedNumber(batch.quantity) - issuedQtyForThisBatch;
                    const sg = batch.specificGravity || 1;
                    const unit = (batch.unit || '').toLowerCase();
                    let convertedQty = 0;
                    if (unit === 'kg') { convertedQty = remainingQty; } else if (unit === 'g') { convertedQty = remainingQty / 1000; } else if (unit === 'l') { convertedQty = remainingQty * sg; } else if (unit === 'ml') { convertedQty = (remainingQty * sg) / 1000; }
                    totalConvertedKg += convertedQty;
                });
                return { '원료명': item.name, '원료 코드': item.code, '현재고': stockStrings, '환산 재고 (KG)': totalConvertedKg.toFixed(2) };
            });

            const issuedQtys = {};
            globalIssuingData.forEach(issue => { issuedQtys[issue.receivingId] = (issuedQtys[issue.receivingId] || 0) + parseFormattedNumber(issue.quantity); });
            const receivingData = globalReceivingData.map(item => { const remainingStock = parseFormattedNumber(item.quantity) - (issuedQtys[item.id] || 0); const expiryDate = new Date(item.expiryDate); const today = new Date(); today.setHours(0, 0, 0, 0); const remainingDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24)); return { '입고일': item.date, '원료명': item.materialName, '원료 코드': item.materialCode, '시험번호': item.testNo, '입고량': `${item.quantity} ${item.unit || ''}`, '남은 재고': `${remainingStock} ${item.unit || ''}`, '업체명': item.supplier, '유통기한': item.expiryDate, '잔여일': remainingDays >= 0 ? `${remainingDays}일` : '만료', '비고': item.remarks }; });
            const issuingData = globalIssuingData.map(item => ({ '출고일': item.date, '원료명': item.materialName, '원료 코드': item.materialCode, '시험번호': item.testNo, '출고량': `${item.quantity} ${item.unit || ''}`, '제품명': item.productName, '제조번호': item.mfgNo, '비고': item.remarks }));
            
            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(inventoryData);
            const ws2 = XLSX.utils.json_to_sheet(receivingData);
            const ws3 = XLSX.utils.json_to_sheet(issuingData);
            XLSX.utils.book_append_sheet(wb, ws1, "실시간 재고 현황");
            XLSX.utils.book_append_sheet(wb, ws2, "입고 내역");
            XLSX.utils.book_append_sheet(wb, ws3, "출고 내역");
            const todayStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `원료수불대장_${todayStr}.xlsx`);
        }
    </script>
</body>
</html>
