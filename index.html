<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한성헬시온 원료 수불부</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- SheetJS 라이브러리 추가 (엑셀 저장용) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
        }
        .table-cell {
            padding: 0.75rem;
            vertical-align: middle;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        #inventory-list tr, #receiving-list tr, #issuing-list tr {
            cursor: pointer;
        }
        .remarks-cell {
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* Adjust as needed */
        }
        .sortable {
            cursor: pointer;
            position: relative;
        }
        .sortable::after { content: '↕'; position: absolute; right: 10px; color: #9ca3af; opacity: 0.5; }
        .sortable.asc::after { content: '↑'; opacity: 1; }
        .sortable.desc::after { content: '↓'; opacity: 1; }
        .converted-value {
            color: #3b82f6; /* blue-500 */
            font-weight: 600;
            cursor: pointer;
        }

        /* 인쇄용 스타일 */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: white;
            }
            #app {
                padding: 0;
            }
            #content-area > div {
                display: none !important;
            }
            #content-area > div:not(.hidden) {
                display: block !important;
                box-shadow: none;
                padding: 0;
            }
            table {
                font-size: 10px;
                border-collapse: collapse;
            }
            .table-cell, th, td {
                border: 1px solid #ddd;
                padding: 4px;
            }
            th.no-print-col, td.no-print-col {
                display: none; /* 작업 열 숨기기 */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="w-full p-4 md:p-8">
        <header class="relative text-center mb-8 no-print">
            <div id="current-time-display" class="absolute top-0 right-0 p-4 text-sm md:text-base font-semibold text-gray-700"></div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">한성헬시온 원료 수불부</h1>
            <p class="text-gray-600 mt-2">원료의 입고, 출고 및 재고를 실시간으로 관리합니다.</p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="manage-units-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">단위 관리</button>
                <button id="print-btn" class="bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700 transition-colors">인쇄</button>
                <button id="save-btn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700 transition-colors">엑셀 다운</button>
                <button id="upload-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors">엑셀 업로드</button>
                <input type="file" id="excel-upload-input" class="hidden" accept=".xlsx, .xls">
                <button id="settings-btn" title="비밀번호 관리" class="bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-800 transition-colors">⚙️</button>
            </div>
        </header>

        <!-- 입고 관리 -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8 no-print">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">원료 입고 등록</h2>
            <form id="receiving-form" class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Left Column: Input Fields -->
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-4 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col md:col-span-1 lg:col-span-1">
                            <label for="receive-date" class="text-sm font-medium text-gray-700 mb-1">입고일</label>
                            <input type="date" id="receive-date" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col md:col-span-1 lg:col-span-1">
                            <label for="receive-material-name" class="text-sm font-medium text-gray-700 mb-1">원료명</label>
                            <input type="text" id="receive-material-name" placeholder="원료명" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col md:col-span-1 lg:col-span-1">
                            <label for="receive-material-code" class="text-sm font-medium text-gray-700 mb-1">원료 코드</label>
                            <input type="text" id="receive-material-code" placeholder="원료 코드" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col md:col-span-1 lg:col-span-1">
                            <label for="receive-test-no" class="text-sm font-medium text-gray-700 mb-1">시험번호</label>
                            <input type="text" id="receive-test-no" placeholder="시험번호" class="p-2 border rounded" required>
                        </div>

                        <div class="flex flex-col md:col-span-1 lg:col-span-1">
                            <label for="receive-quantity" class="text-sm font-medium text-gray-700 mb-1">입고량 / 단위 / 비중</label>
                            <div class="flex gap-1">
                                <input type="text" id="receive-quantity" placeholder="입고량" class="p-2 border rounded w-full" required>
                                <select id="receive-unit" class="p-2 border rounded w-full" required></select>
                                <input type="number" id="receive-specific-gravity" placeholder="비중" step="0.01" class="p-2 border rounded w-full hidden">
                            </div>
                        </div>
                        <div class="flex flex-col md:col-span-1 lg:col-span-1">
                            <label for="receive-expiry-date" class="text-sm font-medium text-gray-700 mb-1">유통기한</label>
                            <input type="date" id="receive-expiry-date" class="p-2 border rounded" required>
                        </div>
                        <div class="flex flex-col md:col-span-1 lg:col-span-1">
                            <label for="receive-manufacturer" class="text-sm font-medium text-gray-700 mb-1">원료사</label>
                            <input type="text" id="receive-manufacturer" placeholder="원료사" class="p-2 border rounded">
                        </div>
                        <div class="flex flex-col md:col-span-1 lg:col-span-1">
                            <label for="receive-supplier" class="text-sm font-medium text-gray-700 mb-1">업체명</label>
                            <input type="text" id="receive-supplier" placeholder="업체명" class="p-2 border rounded">
                        </div>
                    </div>
                    <!-- Right Column: Remarks -->
                    <div class="lg:col-span-1 flex flex-col">
                        <label for="receive-remarks" class="text-sm font-medium text-gray-700 mb-1">비고</label>
                        <textarea id="receive-remarks" placeholder="비고" class="p-2 border rounded h-full flex-grow"></textarea>
                    </div>
                </div>
                <!-- Submit button below the grid -->
                <div class="mt-6">
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-300 w-full font-semibold">입고 등록</button>
                </div>
            </form>
        </div>

        <!-- 탭 메뉴 -->
        <div class="mb-8 no-print">
            <div class="flex border-b">
                <button id="tab-inventory" class="py-2 px-4 bg-white font-semibold text-blue-600 border-b-2 border-blue-600">실시간 재고 현황</button>
                <button id="tab-receiving" class="py-2 px-4 text-gray-500 font-semibold hover:text-blue-600">입고 내역</button>
                <button id="tab-issuing" class="py-2 px-4 text-gray-500 font-semibold hover:text-blue-600">출고 내역</button>
            </div>
        </div>

        <!-- 컨텐츠 영역 -->
        <div id="content-area">
            <!-- 실시간 재고 현황 -->
            <div id="inventory-content" class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <h3 class="text-xl font-bold">실시간 재고 현황</h3>
                    <select id="inventory-filter" class="p-2 border rounded no-print">
                        <option value="all">전체</option>
                        <option value="name">원료명</option>
                        <option value="code">원료 코드</option>
                        <option value="currentStockStr">현 재고</option>
                        <option value="earliestExpiryDate">유통기한</option>
                        <option value="remainingDays">잔여일</option>
                        <option value="remarks">비고</option>
                    </select>
                    <input type="text" id="inventory-search" placeholder="검색..." class="p-2 border rounded w-full md:w-auto flex-grow no-print">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="table-cell text-center">번호</th>
                                <th class="table-cell text-left sortable" data-sort="name">원료명</th>
                                <th class="table-cell text-center sortable" data-sort="code">원료 코드</th>
                                <th class="table-cell text-center">현 재고</th>
                                <th class="table-cell text-center">원료사</th>
                                <th class="table-cell text-center">유통기한</th>
                                <th class="table-cell text-center">잔여일</th>
                                <th class="table-cell text-left">비고</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- 입고 내역 -->
            <div id="receiving-content" class="bg-white p-6 rounded-lg shadow-lg hidden">
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <h3 class="text-xl font-bold">입고 내역</h3>
                     <select id="receiving-filter" class="p-2 border rounded no-print">
                        <option value="all">전체</option>
                        <option value="date">입고일</option>
                        <option value="materialName">원료명</option>
                        <option value="materialCode">원료 코드</option>
                        <option value="testNo">시험번호</option>
                        <option value="quantity">입고량</option>
                        <option value="remainingStock">남은 재고</option>
                        <option value="supplier">업체명</option>
                        <option value="manufacturer">원료사</option>
                        <option value="expiryDate">유통기한</option>
                        <option value="remainingDays">잔여일</option>
                        <option value="remarks">비고</option>
                    </select>
                    <input type="text" id="receiving-search" placeholder="검색..." class="p-2 border rounded w-full md:w-auto flex-grow no-print">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="table-cell text-center sortable" data-sort="date">입고일</th>
                                <th class="table-cell text-left sortable" data-sort="materialName">원료명</th>
                                <th class="table-cell text-center sortable" data-sort="materialCode">원료 코드</th>
                                <th class="table-cell text-center">시험번호</th>
                                <th class="table-cell text-center sortable" data-sort="quantity">입고량</th>
                                <th class="table-cell text-center sortable" data-sort="remainingStock">남은 재고</th>
                                <th class="table-cell text-center sortable" data-sort="manufacturer">원료사</th>
                                <th class="table-cell text-center sortable" data-sort="supplier">업체명</th>
                                <th class="table-cell text-center sortable" data-sort="expiryDate">유통기한</th>
                                <th class="table-cell text-center sortable" data-sort="remainingDays">잔여일</th>
                                <th class="table-cell text-left">비고</th>
                                <th class="table-cell text-center no-print-col">작업</th>
                            </tr>
                        </thead>
                        <tbody id="receiving-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- 출고 내역 -->
            <div id="issuing-content" class="bg-white p-6 rounded-lg shadow-lg hidden">
                 <div class="flex flex-wrap gap-4 items-center mb-4">
                    <h3 class="text-xl font-bold">출고 내역</h3>
                    <select id="issuing-filter" class="p-2 border rounded no-print">
                        <option value="all">전체</option>
                        <option value="date">출고일</option>
                        <option value="materialName">원료명</option>
                        <option value="materialCode">원료 코드</option>
                        <option value="testNo">시험번호</option>
                        <option value="quantity">출고량</option>
                        <option value="productName">제품명</option>
                        <option value="mfgNo">제조번호</option>
                        <option value="remarks">비고</option>
                    </select>
                    <input type="text" id="issuing-search" placeholder="검색..." class="p-2 border rounded w-full md:w-auto flex-grow no-print">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="table-cell text-center sortable" data-sort="date">출고일</th>
                                <th class="table-cell text-left sortable" data-sort="materialName">원료명</th>
                                <th class="table-cell text-center sortable" data-sort="materialCode">원료 코드</th>
                                <th class="table-cell text-center">시험번호</th>
                                <th class="table-cell text-center sortable" data-sort="quantity">출고량</th>
                                <th class="table-cell text-center sortable" data-sort="manufacturer">원료사</th>
                                <th class="table-cell text-center sortable" data-sort="productName">제품명</th>
                                <th class="table-cell text-center">제조번호</th>
                                <th class="table-cell text-left">비고</th>
                                <th class="table-cell text-center no-print-col">작업</th>
                            </tr>
                        </thead>
                        <tbody id="issuing-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 입고 수정 모달 -->
    <div id="edit-receiving-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="text-xl font-bold mb-4">입고 내역 수정</h3>
            <form id="edit-receiving-form" class="space-y-4">
                <input type="hidden" id="edit-receiving-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">입고일</label><input type="date" id="edit-receive-date" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">원료명</label><input type="text" id="edit-receive-material-name" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">원료 코드</label><input type="text" id="edit-receive-material-code" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">시험번호</label><input type="text" id="edit-receive-test-no" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">입고량</label><input type="text" id="edit-receive-quantity" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">단위 / 비중</label><div class="flex gap-2"><select id="edit-receive-unit" class="p-2 border rounded w-full" required></select><input type="number" id="edit-receive-specific-gravity" placeholder="비중" step="0.01" class="p-2 border rounded w-full hidden"></div></div>
                    <div><label class="block text-sm font-medium">원료사</label><input type="text" id="edit-receive-manufacturer" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm font-medium">업체명</label><input type="text" id="edit-receive-supplier" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm font-medium">유통기한</label><input type="date" id="edit-receive-expiry-date" class="p-2 border rounded w-full" required></div>
                </div>
                <div><label class="block text-sm font-medium">비고</label><textarea id="edit-receive-remarks" class="p-2 border rounded w-full" rows="3"></textarea></div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-receiving" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700">수정 저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 출고 수정 모달 -->
    <div id="edit-issuing-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="text-xl font-bold mb-4">출고 내역 수정</h3>
            <form id="edit-issuing-form" class="space-y-4">
                <input type="hidden" id="edit-issuing-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">출고일</label><input type="date" id="edit-issue-date" class="p-2 border rounded w-full" required></div>
                    <div>
                        <label class="block text-sm font-medium">출고량</label>
                        <div class="flex gap-2">
                            <input type="text" id="edit-issue-quantity" placeholder="출고량" class="p-2 border rounded w-2/3" required>
                            <select id="edit-issue-unit" class="p-2 border rounded w-1/3" required></select>
                        </div>
                    </div>
                    <div><label class="block text-sm font-medium">시험번호</label><input type="text" id="edit-issue-test-no" class="p-2 border rounded w-full" required></div>
                    <div><label class="block text-sm font-medium">제품명</label><input type="text" id="edit-issue-product-name" class="p-2 border rounded w-full"></div>
                    <div><label class="block text-sm font-medium">제조번호</label><input type="text" id="edit-issue-mfg-no" class="p-2 border rounded w-full"></div>
                </div>
                <div><label class="block text-sm font-medium">비고</label><textarea id="edit-issue-remarks" class="p-2 border rounded w-full" rows="3"></textarea></div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-issuing" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700">수정 저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 출고 처리 모달 -->
    <div id="issue-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">원료 출고 처리</h3>
            <form id="issuing-form">
                <input type="hidden" id="issue-receiving-id">
                <div class="mb-4"><label class="block mb-1">원료명</label><p id="issue-modal-material-name" class="font-semibold"></p></div>
                <div class="mb-4"><label class="block mb-1">원료 코드</label><p id="issue-modal-material-code" class="font-semibold"></p></div>
                <div class="mb-4"><label class="block mb-1">해당 배치 재고</label><p id="issue-modal-batch-stock" class="font-semibold"></p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="date" id="issue-date" class="p-2 border rounded" required>
                    <div class="flex gap-2">
                        <input type="text" id="issue-quantity" placeholder="출고량" class="p-2 border rounded w-2/3" required>
                        <select id="issue-unit" class="p-2 border rounded w-1/3" required></select>
                    </div>
                    <input type="text" id="issue-test-no" placeholder="시험번호" class="p-2 border rounded" required>
                    <input type="text" id="issue-product-name" placeholder="제품명" class="p-2 border rounded">
                    <input type="text" id="issue-mfg-no" placeholder="제조번호" class="p-2 border rounded">
                    <textarea id="issue-remarks" placeholder="비고" class="p-2 border rounded md:col-span-2" rows="3"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-issue" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">출고 처리</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 재고 상세 정보 모달 -->
    <div id="detail-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="detail-modal-title" class="text-2xl font-bold">재고 상세 내역</h3>
                <button id="close-detail-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="mb-8">
                <h4 class="text-lg font-semibold mb-2 border-b pb-1">입고 내역</h4>
                <div class="overflow-x-auto max-h-60"><table class="w-full text-left border-collapse"><thead class="bg-gray-200 sticky top-0"><tr><th class="table-cell text-center">입고일</th><th class="table-cell text-center">시험번호</th><th class="table-cell text-center">입고량</th><th class="table-cell text-center">업체명</th><th class="table-cell text-center">유통기한</th><th class="table-cell text-left">비고</th></tr></thead><tbody id="detail-receiving-list"></tbody></table></div>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-2 border-b pb-1">출고 내역</h4>
                <div class="overflow-x-auto max-h-60"><table class="w-full text-left border-collapse"><thead class="bg-gray-200 sticky top-0"><tr><th class="table-cell text-center">출고일</th><th class="table-cell text-center">시험번호</th><th class="table-cell text-center">출고량</th><th class="table-cell text-center">제품명</th><th class="table-cell text-center">제조번호</th><th class="table-cell text-left">비고</th></tr></thead><tbody id="detail-issuing-list"></tbody></table></div>
            </div>
        </div>
    </div>
    
    

    <!-- 비고 전체 보기 모달 -->
    <div id="remarks-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">비고 전체 내용</h3>
                <button id="close-remarks-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <p id="remarks-modal-content" class="text-gray-700 whitespace-pre-wrap bg-gray-100 p-4 rounded"></p>
        </div>
    </div>
    
    <!-- 비고 수정 모달 -->
    <div id="edit-remarks-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4">비고 수정</h3>
            <form id="edit-remarks-form">
                <input type="hidden" id="edit-remarks-doc-id">
                <textarea id="edit-remarks-textarea" class="p-2 border rounded w-full" rows="5" required></textarea>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-remarks" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 단위 관리 모달 -->
    <div id="unit-management-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">단위 관리</h3>
                <button id="close-unit-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="unit-form" class="flex gap-2 mb-4">
                <input type="hidden" id="unit-id">
                <input type="text" id="unit-name" placeholder="단위명 (예: kg, L)" class="p-2 border rounded flex-grow" required>
                <button type="submit" id="submit-unit-btn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">추가</button>
                <button type="button" id="cancel-edit-unit-btn" class="bg-gray-500 text-white px-4 rounded hover:bg-gray-600 hidden">취소</button>
            </form>
            <div>
                <h4 class="text-lg font-semibold mb-2">등록된 단위 목록</h4>
                <ul id="unit-list-management" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Unit items will be populated here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- 비밀번호 관리 모달 -->
    <div id="password-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">비밀번호 관리</h3>
                <button id="close-password-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="password-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="password-receiving-edit" class="block text-sm font-medium text-gray-700">입고 수정</label>
                        <input type="password" id="password-receiving-edit" class="p-2 border rounded w-full" required>
                    </div>
                    <div>
                        <label for="password-receiving-delete" class="block text-sm font-medium text-gray-700">입고 삭제</label>
                        <input type="password" id="password-receiving-delete" class="p-2 border rounded w-full" required>
                    </div>
                    <div>
                        <label for="password-issuing-edit" class="block text-sm font-medium text-gray-700">출고 수정</label>
                        <input type="password" id="password-issuing-edit" class="p-2 border rounded w-full" required>
                    </div>
                    <div>
                        <label for="password-issuing-delete" class="block text-sm font-medium text-gray-700">출고 삭제</label>
                        <input type="password" id="password-issuing-delete" class="p-2 border rounded w-full" required>
                    </div>
                    <div>
                        <label for="password-excel-download" class="block text-sm font-medium text-gray-700">엑셀 다운로드</label>
                        <input type="password" id="password-excel-download" class="p-2 border rounded w-full" required>
                    </div>
                    <div>
                        <label for="password-excel-upload" class="block text-sm font-medium text-gray-700">엑셀 업로드</label>
                        <input type="password" id="password-excel-upload" class="p-2 border rounded w-full" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-password-change" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 엑셀 업로드 방식 선택 모달 -->
    <div id="upload-choice-modal" class="modal-backdrop hidden no-print">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="text-xl font-bold mb-4">엑셀 업로드 방식 선택</h3>
            <p class="mb-6">어떤 방식으로 데이터를 업로드하시겠습니까?</p>
            <div class="flex justify-end gap-4">
                <button id="upload-append-btn" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">추가하기</button>
                <button id="upload-overwrite-btn" class="bg-red-600 text-white p-2 rounded hover:bg-red-700">덮어쓰기</button>
                <button id="cancel-upload-choice-btn" class="bg-gray-300 text-gray-800 p-2 rounded hover:bg-gray-400">취소</button>
            </div>
            <p class="text-sm text-gray-600 mt-4">
                <strong>추가하기:</strong> 기존 데이터를 유지하고 엑셀의 데이터를 추가합니다.<br>
                <strong>덮어쓰기:</strong> 기존의 모든 데이터를 삭제하고 엑셀 데이터로 교체합니다.
            </p>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports and config
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAMKGrBLshg6lpO0pCtp7jdIhiCjAmM1WQ",
            authDomain: "management-raw.firebaseapp.com",
            projectId: "management-raw",
            storageBucket: "management-raw.appspot.com",
            messagingSenderId: "697218209723",
            appId: "1:697218209723:web:30c6baadc3713ececd569e"
        };

        // --- 아래 코드는 수정할 필요 없습니다. ---
        let app, db, appId;
        let receivingCollection, issuingCollection, unitsCollection;
        let globalReceivingData = [], globalIssuingData = [], globalUnitsData = [];
        let sortState = {};
        let isDbReady = false;
        let currentAction = { type: null, id: null };
        let uiElements = {};

        try {
            const configToUse = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}'
                ? JSON.parse(__firebase_config)
                : firebaseConfig;

            if (!configToUse.apiKey) {
                 throw new Error("Firebase config is not provided. Please add your config object in the code.");
            }
            
            appId = typeof __app_id !== 'undefined' ? __app_id : configToUse.projectId || 'default-app-id';
            app = initializeApp(configToUse);
            db = getFirestore(app);
            isDbReady = true;

            initializeCollections();
            loadAndRenderData();

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.addEventListener('DOMContentLoaded', () => {
                const errorBanner = document.createElement('div');
                errorBanner.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 no-print';
                errorBanner.setAttribute('role', 'alert');
                errorBanner.innerHTML = `<p class="font-bold">데이터베이스 연결 실패</p><p>Firebase 설정이 올바르지 않습니다. 코드 상단의 firebaseConfig 부분을 확인하고 자신의 설정으로 교체해주세요.</p>`;
                const appDiv = document.getElementById('app');
                if (appDiv) appDiv.prepend(errorBanner);
            });
        }
        
        function initializeUIElements() {
            uiElements = {
                editReceivingModal: document.getElementById('edit-receiving-modal'),
                editReceivingForm: document.getElementById('edit-receiving-form'),
                cancelEditReceivingBtn: document.getElementById('cancel-edit-receiving'),
                editRemarksModal: document.getElementById('edit-remarks-modal'),
                editRemarksForm: document.getElementById('edit-remarks-form'),
                cancelEditRemarksBtn: document.getElementById('cancel-edit-remarks'),
                uploadBtn: document.getElementById('upload-btn'),
                excelUploadInput: document.getElementById('excel-upload-input'),
                manageUnitsBtn: document.getElementById('manage-units-btn'),
                unitManagementModal: document.getElementById('unit-management-modal'),
                closeUnitModalBtn: document.getElementById('close-unit-modal'),
                unitForm: document.getElementById('unit-form'),
                unitIdInput: document.getElementById('unit-id'),
                unitNameInput: document.getElementById('unit-name'),
                submitUnitBtn: document.getElementById('submit-unit-btn'),
                cancelEditUnitBtn: document.getElementById('cancel-edit-unit-btn'),
                unitListManagement: document.getElementById('unit-list-management'),
                receiveUnitSelect: document.getElementById('receive-unit'),
                issueUnitSelect: document.getElementById('issue-unit'),
                receiveQuantityInput: document.getElementById('receive-quantity'),
                issueQuantityInput: document.getElementById('issue-quantity'),
                receiveSpecificGravityInput: document.getElementById('receive-specific-gravity'),
                printBtn: document.getElementById('print-btn'),
                saveBtn: document.getElementById('save-btn'),
                receivingForm: document.getElementById('receiving-form'),
                issuingForm: document.getElementById('issuing-form'),
                receivingList: document.getElementById('receiving-list'),
                issuingList: document.getElementById('issuing-list'),
                inventoryList: document.getElementById('inventory-list'),
                issueModal: document.getElementById('issue-modal'),
                detailModal: document.getElementById('detail-modal'),
                cancelIssueBtn: document.getElementById('cancel-issue'),
                closeDetailModalBtn: document.getElementById('close-detail-modal'),
                remarksModal: document.getElementById('remarks-modal'),
                closeRemarksModalBtn: document.getElementById('close-remarks-modal'),
                remarksModalContent: document.getElementById('remarks-modal-content'),
                searchInputs: {
                    inventory: document.getElementById('inventory-search'),
                    receiving: document.getElementById('receiving-search'),
                    issuing: document.getElementById('issuing-search'),
                },
                searchFilters: {
                    inventory: document.getElementById('inventory-filter'),
                    receiving: document.getElementById('receiving-filter'),
                    issuing: document.getElementById('issuing-filter'),
                }
            };
        }

        // --- Formatting Utility ---
        function formatNumber(num) {
            if (num === null || num === undefined) return '';
            let numStr = String(num).replace(/,/g, '');

            const parts = numStr.split('.');
            const integerPart = parts[0];
            const decimalPart = parts[1];

            if (isNaN(Number(integerPart))) {
                return numStr;
            }
            
            const formattedIntegerPart = new Intl.NumberFormat('en-US').format(Number(integerPart || 0));

            if (integerPart === '' && decimalPart !== undefined) { // Handles inputs like ".123"
                return '0.' + decimalPart;
            }

            if (decimalPart !== undefined) {
                return formattedIntegerPart + '.' + decimalPart;
            }
            
            if (numStr.endsWith('.')) {
                return formattedIntegerPart + '.';
            }

            return formattedIntegerPart;
        }

        function formatNumberInput(e) {
            const input = e.target;
            let value = input.value;
            const originalValue = value.replace(/,/g, '');

            // This validation is from the original code. It clears the input on invalid chars.
            if (isNaN(originalValue) && !(originalValue.endsWith('.') && (originalValue.match(/\./g) || []).length === 1)) {
                 input.value = '';
                 return;
            }

            const formattedValue = formatNumber(originalValue);
            input.value = formattedValue;
        }

        function parseFormattedNumber(value) {
            return Number(String(value).replace(/,/g, ''));
        }

        // --- 초성 검색 유틸리티 ---
        const CHO = "ㄱㄲㄴㄷㄸㄹㅁㅂㅃㅅㅆㅇㅈㅉㅊㅋㅌㅍㅎ";
        const isKorean = (char) => char.match(/[ㄱ-ㅎ가-힣]/);
        const getChosung = (char) => {
            if (!isKorean(char)) return char;
            const code = char.charCodeAt(0) - 44032;
            if (code < 0) return char;
            return CHO[Math.floor(code / 588)];
        };
        const chosungMatch = (str, search) => {
            if (!search) return true;
            str = String(str).toLowerCase();
            search = search.toLowerCase();
            if (!isKorean(search.charAt(0))) return str.includes(search);
            let searchChosung = "";
            for (let i = 0; i < search.length; i++) searchChosung += getChosung(search[i]);
            let strChosung = "";
            for (let i = 0; i < str.length; i++) strChosung += getChosung(str[i]);
            return strChosung.includes(searchChosung);
        };

        // --- 한국 시간(KST) 반환 유틸리티 ---
        function getKSTDate() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
            const KST_OFFSET = 9 * 60 * 60 * 1000;
            return new Date(utc + KST_OFFSET);
        }

        function updateClock() {
            const timeDisplay = document.getElementById('current-time-display');
            if (!timeDisplay) return;

            const kstDate = getKSTDate();
            const year = kstDate.getFullYear();
            const month = String(kstDate.getMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getDate()).padStart(2, '0');
            const hours = String(kstDate.getHours()).padStart(2, '0');
            const minutes = String(kstDate.getMinutes()).padStart(2, '0');
            const seconds = String(kstDate.getSeconds()).padStart(2, '0');

            timeDisplay.textContent = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // --- Notification Utility ---
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white z-2000 ${isError ? 'bg-red-500' : 'bg-blue-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function formatDateFromExcel(data) {
            if (!data) return '';

            let date;
            // Handle Excel serial date number
            if (typeof data === 'number') {
                // The number 25569 is the number of days from 1900-01-01 to 1970-01-01.
                // Excel for Windows incorrectly assumes 1900 was a leap year.
                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                date = new Date(excelEpoch.getTime() + data * 86400000);
            } else if (data instanceof Date) {
                date = data;
            } else if (typeof data === 'string') {
                // Try to parse strings like 'YYYY-MM-DD' or 'MM/DD/YYYY'
                // Adding 'T00:00:00' helps ensure it's parsed as local time midnight
                const parsed = new Date(data + 'T00:00:00');
                if (!isNaN(parsed.getTime())) {
                    date = parsed;
                } else {
                    return data; // Return original string if it's not a valid date
                }
            } else {
                return '';
            }

            // At this point, 'date' is a Date object. We want to format it as YYYY-MM-DD
            // using the date's components in its own timezone, not UTC's.
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;
        }

        function checkPassword(type) {
            const password = prompt("비밀번호를 입력하세요.");
            let correctPassword;
            if (type === 'admin') {
                correctPassword = '930112';
            } else {
                correctPassword = localStorage.getItem(`password-${type}`) || '0000';
            }

            if (password === correctPassword) {
                return true;
            } else {
                if (password !== null) { // 사용자가 취소를 누르지 않았을 경우
                    showNotification('비밀번호가 올바르지 않습니다.', true);
                }
                return false;
            }
        }

        function initializeCollections() {
            if (!isDbReady) return;
            console.log("Firebase is ready, initializing collections."); // 이 줄을 추가합니다.
            const commonPath = `artifacts/${appId}`;
            receivingCollection = collection(db, `${commonPath}/receiving`);
            issuingCollection = collection(db, `${commonPath}/issuing`);
            unitsCollection = collection(db, `${commonPath}/units`);
        }

        // --- Data Processing ---
        function processAndRenderAll() {
            renderInventory();
            renderReceivingList();
            renderIssuingList();
        }

        function getFilteredAndSortedData(data, searchInput, filterSelect, sortKey, allFieldsToSearch) {
            const searchTerm = searchInput.value;
            const selectedFilter = filterSelect.value;

            const filtered = data.filter(item => {
                if (!searchTerm) return true;
                
                if (selectedFilter === 'all') {
                    return allFieldsToSearch.some(field => chosungMatch(item[field], searchTerm));
                } else {
                    return chosungMatch(item[selectedFilter], searchTerm);
                }
            });

            if (sortState[sortKey] && sortState[sortKey].key) {
                const { key, direction } = sortState[sortKey];
                filtered.sort((a, b) => {
                    let valA = a[key], valB = b[key];
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            return filtered;
        }

        // --- Data Loading and Rendering ---
        function loadAndRenderData() {
            if (!isDbReady) return;
            
            // Load Units first
            onSnapshot(unitsCollection, (unitSnapshot) => {
                globalUnitsData = unitSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUnitManagementList();
                populateUnitDropdowns();
            });

            // Load main data
            onSnapshot(receivingCollection, (receivingSnapshot) => {
                globalReceivingData = receivingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                onSnapshot(issuingCollection, (issuingSnapshot) => {
                    globalIssuingData = issuingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    processAndRenderAll();
                });
            });
        }

        function renderInventory() {
            const inventory = {};
            const issuedQtysInKg = {};

            globalIssuingData.forEach(issue => {
                const receivingDoc = globalReceivingData.find(r => r.id === issue.receivingId);
                const sg = receivingDoc ? (parseFloat(receivingDoc.specificGravity) || 1) : 1;
                const issueQty = parseFormattedNumber(issue.quantity);
                const issueUnit = (issue.unit || '').toLowerCase();
                let issueInKg = 0;

                if (issueUnit === 'kg') {
                    issueInKg = issueQty;
                } else if (issueUnit === 'l') {
                    issueInKg = issueQty * sg;
                } else if (issueUnit === 'ml') {
                    issueInKg = (issueQty * sg) / 1000;
                } else {
                    issueInKg = issueQty; // Assume weight-based if not volume
                }
                issuedQtysInKg[issue.receivingId] = (issuedQtysInKg[issue.receivingId] || 0) + issueInKg;
            });

            globalReceivingData.forEach(item => {
                const key = `${item.materialName}_${item.materialCode}`;
                if (!inventory[key]) {
                    inventory[key] = { name: item.materialName, code: item.materialCode, stock: {}, batches: [] };
                }

                const sg = parseFloat(item.specificGravity) || 1;
                const itemQty = parseFormattedNumber(item.quantity);
                const itemUnit = (item.unit || '').toLowerCase();
                let itemQtyInKg = 0;

                if (itemUnit === 'kg') {
                    itemQtyInKg = itemQty;
                } else if (itemUnit === 'l') {
                    itemQtyInKg = itemQty * sg;
                } else if (itemUnit === 'ml') {
                    itemQtyInKg = (itemQty * sg) / 1000;
                } else {
                    itemQtyInKg = itemQty; // Assume weight-based
                }

                const totalIssuedInKg = issuedQtysInKg[item.id] || 0;
                const remainingStockInKg = itemQtyInKg - totalIssuedInKg;

                if (remainingStockInKg > 0.0001) { // Use a small epsilon to avoid floating point issues
                    let remainingStockInOriginalUnit;
                    if (itemUnit === 'kg' || sg === 0) {
                        remainingStockInOriginalUnit = remainingStockInKg;
                    } else if (itemUnit === 'l') {
                        remainingStockInOriginalUnit = remainingStockInKg / sg;
                    } else if (itemUnit === 'ml') {
                        remainingStockInOriginalUnit = (remainingStockInKg * 1000) / sg;
                    } else {
                        remainingStockInOriginalUnit = remainingStockInKg;
                    }
                    inventory[key].batches.push({ ...item, remainingStock: remainingStockInOriginalUnit });
                }
            });

            let inventoryData = Object.values(inventory).map(item => {
                const stockByUnit = {};
                let earliestExpiryDate = null;
                let earliestBatch = null;
                let totalKg = 0;
                let manufacturer = '';

                item.batches.forEach(batch => {
                    const unit = (batch.unit || 'N/A').toLowerCase();
                    const sg = parseFloat(batch.specificGravity) || 1;
                    const stock = batch.remainingStock;

                    if (unit === 'kg') {
                        totalKg += stock;
                    } else if (unit === 'l') {
                        totalKg += stock * sg;
                    } else if (unit === 'ml') {
                        totalKg += (stock * sg) / 1000;
                    } else {
                        totalKg += stock;
                    }

                    if (!stockByUnit[batch.unit]) {
                        stockByUnit[batch.unit] = 0;
                    }
                    stockByUnit[batch.unit] += stock;

                    if (!earliestExpiryDate || new Date(batch.expiryDate) < new Date(earliestExpiryDate)) {
                        earliestExpiryDate = batch.expiryDate;
                        earliestBatch = batch;
                    }
                    if (batch.manufacturer) {
                        manufacturer = batch.manufacturer;
                    }
                });

                const hasKgReceiving = globalReceivingData.some(r => r.materialName === item.name && r.materialCode === item.code && (r.unit || '').toLowerCase() === 'kg');
                const hasKgIssuing = globalIssuingData.some(i => i.materialName === item.name && i.materialCode === item.code && (i.unit || '').toLowerCase() === 'kg');

                let stockStrings = '';
                if (totalKg > 0) {
                    stockStrings = `${formatNumber(totalKg.toFixed(3))} kg`;
                } else {
                    stockStrings = Object.entries(stockByUnit).map(([unit, qty]) => `${formatNumber(qty)} ${unit}`).join(', ');
                }
                
                const today = getKSTDate();
                today.setHours(0, 0, 0, 0);
                const expiryDate = earliestBatch ? new Date(earliestBatch.expiryDate + 'T00:00:00') : null;
                const remainingDays = expiryDate ? Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24)) : '';
                
                return { 
                    name: item.name, 
                    code: item.code, 
                    currentStockStr: stockStrings, 
                    manufacturer: manufacturer,
                    earliestExpiryDate: earliestBatch ? earliestBatch.expiryDate : '',
                    remainingDays: remainingDays,
                    remarks: earliestBatch ? earliestBatch.remarks : '',
                    remarksDocId: earliestBatch ? earliestBatch.id : null
                };
            }).filter(item => item.currentStockStr !== ''); // Filter out items with no stock

            const processedData = getFilteredAndSortedData(inventoryData, uiElements.searchInputs.inventory, uiElements.searchFilters.inventory, 'inventory', ['name', 'code', 'currentStockStr', 'earliestExpiryDate', 'remainingDays', 'remarks']);
            
            uiElements.inventoryList.innerHTML = '';
            processedData.forEach((item, index) => {
                const remarksCell = createRemarksCell(item.remarks, item.remarksDocId);
                const row = uiElements.inventoryList.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.dataset.name = item.name;
                row.dataset.code = item.code;
                row.innerHTML = `
                    <td class="table-cell text-center">${index + 1}</td>
                    <td class="table-cell text-left font-medium">${item.name}</td>
                    <td class="table-cell text-center">${item.code}</td>
                    <td class="table-cell text-center font-bold">${item.currentStockStr || '0'}</td>
                    <td class="table-cell text-center">${item.manufacturer || ''}</td>
                    <td class="table-cell text-center">${item.earliestExpiryDate}</td>
                    <td class="table-cell text-center ${item.remainingDays < 60 ? 'text-red-500 font-bold' : ''}">${item.remainingDays >= 0 ? `${item.remainingDays}일` : '만료'}</td>
                    ${remarksCell}
                `;
            });
        }


        function renderReceivingList() {
            const issuedQtysInKg = {};
            globalIssuingData.forEach(issue => {
                const receivingDoc = globalReceivingData.find(r => r.id === issue.receivingId);
                const sg = receivingDoc ? (parseFloat(receivingDoc.specificGravity) || 1) : 1;
                const issueQty = parseFormattedNumber(issue.quantity);
                const issueUnit = (issue.unit || '').toLowerCase();
                let issueInKg = 0;

                if (issueUnit === 'kg') {
                    issueInKg = issueQty;
                } else if (issueUnit === 'l') {
                    issueInKg = issueQty * sg;
                } else if (issueUnit === 'ml') {
                    issueInKg = (issueQty * sg) / 1000;
                } else {
                    issueInKg = issueQty;
                }
                issuedQtysInKg[issue.receivingId] = (issuedQtysInKg[issue.receivingId] || 0) + issueInKg;
            });

            let receivingData = globalReceivingData.map(item => {
                const sg = parseFloat(item.specificGravity) || 1;
                const itemQty = parseFormattedNumber(item.quantity);
                const itemUnit = (item.unit || '').toLowerCase();
                let itemQtyInKg = 0;

                if (itemUnit === 'kg') {
                    itemQtyInKg = itemQty;
                } else if (itemUnit === 'l') {
                    itemQtyInKg = itemQty * sg;
                } else if (itemUnit === 'ml') {
                    itemQtyInKg = (itemQty * sg) / 1000;
                } else {
                    itemQtyInKg = itemQty;
                }

                const totalIssuedInKg = issuedQtysInKg[item.id] || 0;
                const remainingStockInKg = itemQtyInKg - totalIssuedInKg;
                
                let remainingStock; // This is in original unit
                if (itemUnit === 'kg' || sg === 0) {
                    remainingStock = remainingStockInKg;
                } else if (itemUnit === 'l') {
                    remainingStock = remainingStockInKg / sg;
                } else if (itemUnit === 'ml') {
                    remainingStock = (remainingStockInKg * 1000) / sg;
                } else {
                    remainingStock = remainingStockInKg;
                }

                const today = getKSTDate();
                today.setHours(0, 0, 0, 0);
                const expiryDate = new Date(item.expiryDate + 'T00:00:00');
                const remainingDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                return { ...item, remainingStock, remainingDays };
            });
            const processedData = getFilteredAndSortedData(receivingData, uiElements.searchInputs.receiving, uiElements.searchFilters.receiving, 'receiving', ['date', 'materialName', 'materialCode', 'testNo', 'supplier', 'quantity', 'remainingStock', 'expiryDate', 'remainingDays', 'remarks']);
            uiElements.receivingList.innerHTML = '';
            processedData.forEach(item => {
                const remarksCell = createRemarksCell(item.remarks);
                const quantityCell = createQuantityCell(item.quantity, item.unit, item.specificGravity);
                const remainingStockCell = createQuantityCell(item.remainingStock, item.unit, item.specificGravity);
                const isIssued = globalIssuingData.some(issue => issue.receivingId === item.id);
                const materialNameClass = item.updatedAt ? 'text-blue-600 font-bold' : '';

                const row = uiElements.receivingList.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `<td class="table-cell text-center">${item.date}</td><td class="table-cell text-left font-medium ${materialNameClass}">${item.materialName}</td><td class="table-cell text-center">${item.materialCode}</td><td class="table-cell text-center">${item.testNo}</td>${quantityCell}${remainingStockCell}<td class="table-cell text-center">${item.manufacturer || ''}</td><td class="table-cell text-center">${item.supplier}</td><td class="table-cell text-center">${item.expiryDate}</td><td class="table-cell text-center ${item.remainingDays < 60 ? 'text-red-500 font-bold' : ''}">${item.remainingDays >= 0 ? `${item.remainingDays}일` : '만료'}</td>${remarksCell}
                <td class="table-cell no-print-col text-center space-x-2">
                    <button data-id="${item.id}" data-name="${item.materialName}" data-code="${item.materialCode}" data-stock="${item.remainingStock}" data-unit="${item.unit || ''}" class="issue-btn text-sm bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 disabled:bg-gray-400" ${item.remainingStock <= 0 ? 'disabled' : ''}>출고</button>
                    <button data-id="${item.id}" class="edit-btn text-sm bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 disabled:bg-gray-400" ${isIssued ? 'disabled title="출고된 내역은 수정할 수 없습니다."' : ''}>수정</button>
                    <button data-id="${item.id}" class="delete-btn text-sm bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 disabled:bg-gray-400" ${isIssued ? 'disabled title="출고된 내역은 삭제할 수 없습니다."' : ''}>삭제</button>
                </td>`;
            });
        }

        function renderIssuingList() {
            const processedData = getFilteredAndSortedData(globalIssuingData, uiElements.searchInputs.issuing, uiElements.searchFilters.issuing, 'issuing', ['date', 'materialName', 'materialCode', 'testNo', 'quantity', 'manufacturer', 'productName', 'mfgNo', 'remarks']);
            uiElements.issuingList.innerHTML = '';
            processedData.forEach(item => {
                const receivingDoc = globalReceivingData.find(r => r.id === item.receivingId);
                const sg = receivingDoc ? receivingDoc.specificGravity : 1;
                const quantityCell = createQuantityCell(item.quantity, item.unit, sg);
                const remarksCell = createRemarksCell(item.remarks);
                const materialNameClass = item.updatedAt ? 'text-blue-600 font-bold' : '';

                const row = uiElements.issuingList.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `<td class="table-cell text-center">${item.date}</td><td class="table-cell text-left font-medium ${materialNameClass}">${item.materialName}</td><td class="table-cell text-center">${item.materialCode}</td><td class="table-cell text-center">${item.testNo}</td>${quantityCell}<td class="table-cell text-center">${item.manufacturer || ''}</td><td class="table-cell text-center">${item.productName}</td><td class="table-cell text-center">${item.mfgNo}</td>${remarksCell}
                <td class="table-cell no-print-col text-center space-x-2">
                    <button data-id="${item.id}" class="edit-issuing-btn text-sm bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">수정</button>
                    <button data-id="${item.id}" class="delete-issuing-btn text-sm bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">삭제</button>
                </td>`;
            });
        }
        
        function createRemarksCell(remarks, docId = null) {
            const maxLength = 15;
            let content = remarks || '';
            let classes = 'table-cell';
            let title = '';
            let dataAttributes = `data-full-remarks="${remarks || ''}"`;

            if (remarks && remarks.length > maxLength) {
                content = `${remarks.substring(0, maxLength)}...`;
                classes += ' remarks-cell text-blue-600 font-semibold';
                title = '클릭하여 전체 보기';
            }
            
            let editButton = '';
            if (docId) {
                editButton = `<button class="edit-remark-btn ml-2 text-gray-400 hover:text-gray-700 no-print" data-doc-id="${docId}">✏️</button>`;
            }

            return `<td class="${classes} text-left" title="${title}" ${dataAttributes}>${content}${editButton}</td>`;
        }
        
        function createQuantityCell(originalQuantity, originalUnit, specificGravity = 1) {
            const unitLower = (originalUnit || '').toLowerCase();
            const isVolume = unitLower === 'l' || unitLower === 'ml';

            if (isVolume) {
                let convertedKg = 0;
                if (unitLower === 'l') {
                    convertedKg = originalQuantity * specificGravity;
                } else if (unitLower === 'ml') {
                    convertedKg = (originalQuantity * specificGravity) / 1000;
                }
                
                const originalText = `${formatNumber(originalQuantity)} ${originalUnit} (비중: ${specificGravity})`;
                const convertedText = `${formatNumber(convertedKg.toFixed(3))} KG`;

                return `<td class="table-cell text-center">
                            <span class="converted-value" 
                                  data-original-text="${originalText}" 
                                  data-converted-text="${convertedText}"
                                  title="클릭하여 단위 전환">
                                ${convertedText}
                            </span>
                        </td>`;
            } else {
                return `<td class="table-cell text-center">${formatNumber(originalQuantity)} ${originalUnit || ''}</td>`;
            }
        }
        
        function renderUnitManagementList() {
            uiElements.unitListManagement.innerHTML = '';
            globalUnitsData.forEach(unit => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-gray-100 rounded';
                li.innerHTML = `
                    <span>${unit.name}</span>
                    <div class="space-x-2">
                        <button data-id="${unit.id}" data-name="${unit.name}" class="edit-unit-btn text-blue-500 hover:text-blue-700">편집</button>
                        <button data-id="${unit.id}" class="delete-unit-btn text-red-500 hover:text-red-700">삭제</button>
                    </div>
                `;
                uiElements.unitListManagement.appendChild(li);
            });
        }

        function populateUnitDropdowns() {
            const options = globalUnitsData.map(unit => `<option value="${unit.name}">${unit.name}</option>`).join('');
            uiElements.receiveUnitSelect.innerHTML = options;
            uiElements.issueUnitSelect.innerHTML = options;
            document.getElementById('edit-receive-unit').innerHTML = options;
            
            // 'kg'을 기본값으로 설정
            uiElements.receiveUnitSelect.value = 'kg';

            // After populating, check the initial state for the specific gravity input
            toggleSpecificGravityInput(uiElements.receiveUnitSelect, uiElements.receiveSpecificGravityInput);
        }
        
        function toggleSpecificGravityInput(selectElement = uiElements.receiveUnitSelect, inputElement = uiElements.receiveSpecificGravityInput) {
            const selectedUnit = selectElement.value.toLowerCase();
            if (selectedUnit === 'l' || selectedUnit === 'ml') {
                inputElement.classList.remove('hidden');
            } else {
                inputElement.classList.add('hidden');
            }
        }

        // --- Event Handlers ---
        document.addEventListener('DOMContentLoaded', () => {
             initializeUIElements();
             setupEventListeners();
        });

        function setupEventListeners() {
            // Live Clock
            updateClock();
            setInterval(updateClock, 1000);

            // Number formatting
            uiElements.receiveQuantityInput.addEventListener('input', formatNumberInput);
            uiElements.issueQuantityInput.addEventListener('input', formatNumberInput);
            document.getElementById('edit-receive-quantity').addEventListener('input', formatNumberInput);
            document.getElementById('edit-issue-quantity').addEventListener('input', formatNumberInput);

            // Unit select change
            uiElements.receiveUnitSelect.addEventListener('change', () => toggleSpecificGravityInput(uiElements.receiveUnitSelect, uiElements.receiveSpecificGravityInput));
            document.getElementById('edit-receive-unit').addEventListener('change', (e) => toggleSpecificGravityInput(e.target, document.getElementById('edit-receive-specific-gravity')));

            // New Unit Management Listeners
            uiElements.manageUnitsBtn.addEventListener('click', () => uiElements.unitManagementModal.classList.remove('hidden'));
            uiElements.closeUnitModalBtn.addEventListener('click', () => uiElements.unitManagementModal.classList.add('hidden'));
            uiElements.unitForm.addEventListener('submit', handleUnitFormSubmit);
            uiElements.cancelEditUnitBtn.addEventListener('click', cancelUnitEdit);
            uiElements.unitListManagement.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-unit-btn')) {
                    handleDeleteUnit(e.target.dataset.id);
                } else if (e.target.classList.contains('edit-unit-btn')) {
                    handleEditUnit(e.target.dataset.id, e.target.dataset.name);
                }
            });

            // Edit/Delete Listeners
            uiElements.receivingList.addEventListener('click', (e) => {
                if (e.target.classList.contains('issue-btn')) {
                    openIssueModal(e);
                } else if (e.target.classList.contains('edit-btn')) {
                    if (checkPassword('receiving-edit')) {
                        handleEditClick(e.target.dataset.id);
                    }
                } else if (e.target.classList.contains('delete-btn')) {
                    if (checkPassword('receiving-delete')) {
                        handleDeleteClick(e.target.dataset.id);
                    }
                }
            });
            
            uiElements.issuingList.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-issuing-btn')) {
                    if (checkPassword('issuing-edit')) {
                        handleEditIssuingClick(e.target.dataset.id);
                    }
                } else if (e.target.classList.contains('delete-issuing-btn')) {
                    if (checkPassword('issuing-delete')) {
                        handleDeleteIssuingClick(e.target.dataset.id);
                    }
                }
            });
            
            uiElements.editReceivingForm.addEventListener('submit', handleEditReceivingSubmit);
            uiElements.cancelEditReceivingBtn.addEventListener('click', () => uiElements.editReceivingModal.classList.add('hidden'));
            
            // Issuing Edit Modal Listeners
            document.getElementById('edit-issuing-form').addEventListener('submit', handleEditIssuingSubmit);
            document.getElementById('cancel-edit-issuing').addEventListener('click', () => document.getElementById('edit-issuing-modal').classList.add('hidden'));

            // Remark Edit Modal Listeners
            uiElements.editRemarksForm.addEventListener('submit', handleEditRemarksSubmit);
            uiElements.cancelEditRemarksBtn.addEventListener('click', () => uiElements.editRemarksModal.classList.add('hidden'));

            // Existing Listeners
            uiElements.printBtn.addEventListener('click', () => window.print());
            uiElements.uploadBtn.addEventListener('click', () => {
                if (checkPassword('excel-upload')) {
                    document.getElementById('upload-choice-modal').classList.remove('hidden');
                }
            });

            document.getElementById('cancel-upload-choice-btn').addEventListener('click', () => {
                document.getElementById('upload-choice-modal').classList.add('hidden');
            });

            document.getElementById('upload-append-btn').addEventListener('click', () => {
                document.getElementById('upload-choice-modal').classList.add('hidden');
                uiElements.excelUploadInput.dataset.uploadType = 'append';
                uiElements.excelUploadInput.click();
            });

            document.getElementById('upload-overwrite-btn').addEventListener('click', () => {
                document.getElementById('upload-choice-modal').classList.add('hidden');
                uiElements.excelUploadInput.dataset.uploadType = 'overwrite';
                uiElements.excelUploadInput.click();
            });
            uiElements.excelUploadInput.addEventListener('change', handleExcelUpload);
            uiElements.saveBtn.addEventListener('click', () => {
                if (checkPassword('excel-download')) {
                    generateAndDownloadExcel();
                }
            });
            uiElements.receivingForm.addEventListener('submit', handleReceivingSubmit);
            uiElements.issuingForm.addEventListener('submit', handleIssuingSubmit);
            uiElements.inventoryList.addEventListener('click', (e) => handleDetailClick(e));
            Object.values(uiElements.searchInputs).forEach(input => input.addEventListener('input', processAndRenderAll));
            Object.values(uiElements.searchFilters).forEach(filter => filter.addEventListener('change', processAndRenderAll));
            document.querySelectorAll('.sortable').forEach(header => header.addEventListener('click', handleSortClick));
            uiElements.cancelIssueBtn.addEventListener('click', closeIssueModal);
            uiElements.closeDetailModalBtn.addEventListener('click', closeDetailModal);
            uiElements.closeRemarksModalBtn.addEventListener('click', closeRemarksModal);
            document.querySelectorAll('#app button[id^="tab-"]').forEach(tab => tab.addEventListener('click', handleTabClick));
            document.getElementById('content-area').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-remark-btn')) {
                    e.stopPropagation(); // Prevent other click events on the cell
                    handleEditRemarkClick(e.target.dataset.docId);
                } else if (e.target.classList.contains('remarks-cell')) {
                    const fullRemarks = e.target.dataset.fullRemarks;
                    openRemarksModal(fullRemarks);
                } else if (e.target.classList.contains('converted-value')) {
                    const el = e.target;
                    const originalText = el.dataset.originalText;
                    const convertedText = el.dataset.convertedText;
                    if (el.textContent.trim() === convertedText) {
                        el.textContent = originalText;
                    } else {
                        el.textContent = convertedText;
                    }
                }
            });

            // Password Modal Listeners
            document.getElementById('settings-btn').addEventListener('click', () => {
                if (checkPassword('admin')) {
                    document.getElementById('password-receiving-edit').value = localStorage.getItem('password-receiving-edit') || '0000';
                    document.getElementById('password-receiving-delete').value = localStorage.getItem('password-receiving-delete') || '0000';
                    document.getElementById('password-issuing-edit').value = localStorage.getItem('password-issuing-edit') || '0000';
                    document.getElementById('password-issuing-delete').value = localStorage.getItem('password-issuing-delete') || '0000';
                    document.getElementById('password-excel-download').value = localStorage.getItem('password-excel-download') || '0000';
                    document.getElementById('password-excel-upload').value = localStorage.getItem('password-excel-upload') || '0000';
                    document.getElementById('password-modal').classList.remove('hidden');
                }
            });
            document.getElementById('close-password-modal').addEventListener('click', () => document.getElementById('password-modal').classList.add('hidden'));
            document.getElementById('cancel-password-change').addEventListener('click', () => document.getElementById('password-modal').classList.add('hidden'));
            document.getElementById('password-form').addEventListener('submit', (e) => {
                e.preventDefault();
                localStorage.setItem('password-receiving-edit', document.getElementById('password-receiving-edit').value);
                localStorage.setItem('password-receiving-delete', document.getElementById('password-receiving-delete').value);
                localStorage.setItem('password-issuing-edit', document.getElementById('password-issuing-edit').value);
                localStorage.setItem('password-issuing-delete', document.getElementById('password-issuing-delete').value);
                localStorage.setItem('password-excel-download', document.getElementById('password-excel-download').value);
                localStorage.setItem('password-excel-upload', document.getElementById('password-excel-upload').value);
                showNotification('비밀번호가 저장되었습니다.');
                document.getElementById('password-modal').classList.add('hidden');
            });
        }

        async function handleUnitFormSubmit(e) {
            e.preventDefault();
            if (!isDbReady) {
                showNotification('데이터베이스에 연결되지 않아 저장할 수 없습니다.', true);
                return;
            }
            const id = uiElements.unitIdInput.value;
            const name = uiElements.unitNameInput.value.trim();
            if (!name) return;

            try {
                if (id) { // Update
                    const unitRef = doc(unitsCollection, id);
                    await updateDoc(unitRef, { name });
                    showNotification('단위가 수정되었습니다.');
                } else { // Add
                    await addDoc(unitsCollection, { name });
                    showNotification('단위가 추가되었습니다.');
                }
                cancelUnitEdit();
            } catch (error) {
                console.error("Error saving unit:", error);
                showNotification('단위 저장에 실패했습니다.', true);
            }
        }

        function cancelUnitEdit() {
            uiElements.unitIdInput.value = '';
            uiElements.unitNameInput.value = '';
            uiElements.submitUnitBtn.textContent = '추가';
            uiElements.submitUnitBtn.classList.replace('bg-green-600', 'bg-blue-600');
            uiElements.cancelEditUnitBtn.classList.add('hidden');
        }

        function handleEditUnit(id, name) {
            uiElements.unitIdInput.value = id;
            uiElements.unitNameInput.value = name;
            uiElements.submitUnitBtn.textContent = '수정';
            uiElements.submitUnitBtn.classList.replace('bg-blue-600', 'bg-green-600');
            uiElements.cancelEditUnitBtn.classList.remove('hidden');
            uiElements.unitNameInput.focus();
        }

        async function handleDeleteUnit(id) {
            if (confirm('이 단위를 삭제하시겠습니까? 이 단위를 사용한 기존 데이터에는 영향을 주지 않습니다.')) {
                 if (!isDbReady) {
                    showNotification('데이터베이스에 연결되지 않아 삭제할 수 없습니다.', true);
                    return;
                }
                try {
                    const unitRef = doc(unitsCollection, id);
                    await deleteDoc(unitRef);
                    showNotification('단위가 삭제되었습니다.');
                } catch (error) {
                    console.error("Error deleting unit:", error);
                    showNotification('단위 삭제에 실패했습니다.', true);
                }
            }
        }
        
        function handleEditClick(id) {
            openEditModal(id);
        }

        function handleDeleteClick(id) {
            performDelete(id);
        }

        function handleEditIssuingClick(id) {
            openEditIssuingModal(id);
        }

        function handleDeleteIssuingClick(id) {
            performDeleteIssuing(id);
        }

        function openEditModal(id) {
            const item = globalReceivingData.find(d => d.id === id);
            if (!item) return;

            const form = uiElements.editReceivingForm;
            form.querySelector('#edit-receiving-id').value = id;
            form.querySelector('#edit-receive-date').value = item.date;
            form.querySelector('#edit-receive-material-name').value = item.materialName;
            form.querySelector('#edit-receive-material-code').value = item.materialCode;
            form.querySelector('#edit-receive-test-no').value = item.testNo;
            form.querySelector('#edit-receive-quantity').value = item.quantity;
            form.querySelector('#edit-receive-manufacturer').value = item.manufacturer || '';
            form.querySelector('#edit-receive-supplier').value = item.supplier;
            form.querySelector('#edit-receive-expiry-date').value = item.expiryDate;
            form.querySelector('#edit-receive-remarks').value = item.remarks || '';
            
            const unitSelect = form.querySelector('#edit-receive-unit');
            unitSelect.value = item.unit || '';
            
            const sgInput = form.querySelector('#edit-receive-specific-gravity');
            if (item.unit && (item.unit.toLowerCase() === 'l' || item.unit.toLowerCase() === 'ml')) {
                sgInput.classList.remove('hidden');
                sgInput.value = item.specificGravity || '';
            } else {
                sgInput.classList.add('hidden');
            }

            uiElements.editReceivingModal.classList.remove('hidden');
        }

        async function handleEditReceivingSubmit(e) {
            e.preventDefault();
            if (!isDbReady) return;

            const form = e.target;
            const id = form.querySelector('#edit-receiving-id').value;
            const docRef = doc(receivingCollection, id);
            
            const quantity = parseFormattedNumber(form.querySelector('#edit-receive-quantity').value);
            const unit = form.querySelector('#edit-receive-unit').value;
            const specificGravity = form.querySelector('#edit-receive-specific-gravity').value;

            try {
                await updateDoc(docRef, {
                    date: form.querySelector('#edit-receive-date').value,
                    materialName: form.querySelector('#edit-receive-material-name').value,
                    materialCode: form.querySelector('#edit-receive-material-code').value,
                    testNo: form.querySelector('#edit-receive-test-no').value,
                    quantity: quantity,
                    unit: unit,
                    specificGravity: (unit.toLowerCase() === 'l' || unit.toLowerCase() === 'ml') ? specificGravity : '',
                    manufacturer: form.querySelector('#edit-receive-manufacturer').value,
                    supplier: form.querySelector('#edit-receive-supplier').value,
                    expiryDate: form.querySelector('#edit-receive-expiry-date').value,
                    remarks: form.querySelector('#edit-receive-remarks').value,
                    updatedAt: getKSTDate()
                });
                showNotification('입고 내역이 수정되었습니다.');
                uiElements.editReceivingModal.classList.add('hidden');
            } catch (error) {
                console.error("Error updating document: ", error);
                showNotification('수정에 실패했습니다.', true);
            }
        }

        async function performDelete(id) {
            if (confirm('정말로 이 입고 내역을 삭제하시겠습니까? 연관된 출고 내역이 있으면 삭제할 수 없습니다.')) {
                if (!isDbReady) {
                    showNotification('데이터베이스에 연결되지 않았습니다.', true);
                    return;
                }
                // Check if any issuing record is associated with this receiving record
                if (globalIssuingData.some(issue => issue.receivingId === id)) {
                    showNotification('이 입고와 연관된 출고 내역이 있어 삭제할 수 없습니다.', true);
                    return;
                }
                try {
                    await deleteDoc(doc(receivingCollection, id));
                    showNotification('입고 내역이 삭제되었습니다.');
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showNotification('삭제에 실패했습니다.', true);
                }
            }
        }
        
        function openEditIssuingModal(id) {
            const item = globalIssuingData.find(d => d.id === id);
            if (!item) return;

            const modal = document.getElementById('edit-issuing-modal');
            const form = document.getElementById('edit-issuing-form');
            
            form.querySelector('#edit-issuing-id').value = id;
            form.querySelector('#edit-issue-date').value = item.date;
            form.querySelector('#edit-issue-quantity').value = item.quantity;
            form.querySelector('#edit-issue-unit').value = item.unit || '';
            form.querySelector('#edit-issue-test-no').value = item.testNo;
            form.querySelector('#edit-issue-product-name').value = item.productName || '';
            form.querySelector('#edit-issue-mfg-no').value = item.mfgNo || '';
            form.querySelector('#edit-issue-remarks').value = item.remarks || '';

            modal.classList.remove('hidden');
        }

        async function handleEditIssuingSubmit(e) {
            e.preventDefault();
            if (!isDbReady) return;

            const form = e.target;
            const id = form.querySelector('#edit-issuing-id').value;
            const docRef = doc(issuingCollection, id);
            
            const quantity = parseFormattedNumber(form.querySelector('#edit-issue-quantity').value);

            try {
                await updateDoc(docRef, {
                    date: form.querySelector('#edit-issue-date').value,
                    quantity: quantity,
                    unit: form.querySelector('#edit-issue-unit').value,
                    testNo: form.querySelector('#edit-issue-test-no').value,
                    productName: form.querySelector('#edit-issue-product-name').value,
                    mfgNo: form.querySelector('#edit-issue-mfg-no').value,
                    remarks: form.querySelector('#edit-issue-remarks').value,
                    updatedAt: getKSTDate()
                });
                showNotification('출고 내역이 수정되었습니다.');
                document.getElementById('edit-issuing-modal').classList.add('hidden');
            } catch (error) {
                console.error("Error updating issuing document: ", error);
                showNotification('출고 내역 수정에 실패했습니다.', true);
            }
        }

        async function performDeleteIssuing(id) {
            if (confirm('정말로 이 출고 내역을 삭제하시겠습니까?')) {
                if (!isDbReady) {
                    showNotification('데이터베이스에 연결되지 않았습니다.', true);
                    return;
                }
                try {
                    await deleteDoc(doc(issuingCollection, id));
                    showNotification('출고 내역이 삭제되었습니다.');
                } catch (error) {
                    console.error("Error deleting issuing document: ", error);
                    showNotification('출고 내역 삭제에 실패했습니다.', true);
                }
            }
        }


        function handleSortClick(e) {
            const header = e.currentTarget;
            const key = header.dataset.sort;
            const tableId = header.closest('table').parentElement.parentElement.id.replace('-content', '');
            
            if (!sortState[tableId]) {
                sortState[tableId] = { key: null, direction: 'asc' };
            }

            if (sortState[tableId].key === key) {
                sortState[tableId].direction = sortState[tableId].direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState[tableId].key = key;
                sortState[tableId].direction = 'asc';
            }

            document.querySelectorAll(`#${tableId}-content .sortable`).forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            header.classList.add(sortState[tableId].direction);
            
            processAndRenderAll();
        }

        function handleTabClick(e) {
            const clickedTab = e.target;
            const tabId = clickedTab.id; // e.g., "tab-inventory"
            const contentId = tabId.replace('tab-', '') + '-content'; // e.g., "inventory-content"

            // Reset all tabs
            document.querySelectorAll('#app button[id^="tab-"]').forEach(tab => {
                tab.classList.remove('bg-white', 'text-blue-600', 'border-b-2', 'border-blue-600');
                tab.classList.add('text-gray-500', 'hover:text-blue-600');
            });

            // Reset all content areas
            document.querySelectorAll('#content-area > div').forEach(content => {
                content.classList.add('hidden');
            });

            // Activate clicked tab
            clickedTab.classList.add('bg-white', 'text-blue-600', 'border-b-2', 'border-blue-600');
            clickedTab.classList.remove('text-gray-500', 'hover:text-blue-600');

            // Show corresponding content
            const contentToShow = document.getElementById(contentId);
            if (contentToShow) {
                contentToShow.classList.remove('hidden');
            }
        }

        async function handleReceivingSubmit(e) {
            e.preventDefault();
            if (!isDbReady) {
                showNotification('데이터베이스에 연결되지 않아 저장할 수 없습니다.', true);
                return;
            }
            const form = e.target;
            const quantity = parseFormattedNumber(form.querySelector('#receive-quantity').value);
            const unit = form.querySelector('#receive-unit').value;
            const specificGravity = form.querySelector('#receive-specific-gravity').value;

            const newReceiving = {
                date: form.querySelector('#receive-date').value,
                materialName: form.querySelector('#receive-material-name').value,
                materialCode: form.querySelector('#receive-material-code').value,
                testNo: form.querySelector('#receive-test-no').value,
                quantity: quantity,
                unit: unit,
                specificGravity: (unit.toLowerCase() === 'l' || unit.toLowerCase() === 'ml') ? specificGravity : '',
                manufacturer: form.querySelector('#receive-manufacturer').value,
                supplier: form.querySelector('#receive-supplier').value,
                expiryDate: form.querySelector('#receive-expiry-date').value,
                remarks: form.querySelector('#receive-remarks').value,
                createdAt: getKSTDate()
            };

            try {
                await addDoc(receivingCollection, newReceiving);
                showNotification('입고 등록이 완료되었습니다.');
                form.reset();
                toggleSpecificGravityInput(); // Reset SG input visibility
            } catch (error) {
                console.error("Error adding document: ", error);
                showNotification('입고 등록에 실패했습니다.', true);
            }
        }

        async function handleIssuingSubmit(e) {
            e.preventDefault();
            if (!isDbReady) {
                showNotification('데이터베이스에 연결되지 않아 저장할 수 없습니다.', true);
                return;
            }
            const form = e.target;
            const receivingId = form.querySelector('#issue-receiving-id').value;
            const quantity = parseFormattedNumber(form.querySelector('#issue-quantity').value);
            
            const receivingDoc = globalReceivingData.find(r => r.id === receivingId);
            if (!receivingDoc) {
                showNotification('출고할 입고 정보를 찾을 수 없습니다.', true);
                return;
            }

            const newIssuing = {
                receivingId: receivingId,
                date: form.querySelector('#issue-date').value,
                quantity: quantity,
                unit: form.querySelector('#issue-unit').value,
                materialName: receivingDoc.materialName,
                materialCode: receivingDoc.materialCode,
                testNo: form.querySelector('#issue-test-no').value,
                productName: form.querySelector('#issue-product-name').value,
                mfgNo: form.querySelector('#issue-mfg-no').value,
                remarks: form.querySelector('#issue-remarks').value,
                createdAt: getKSTDate()
            };

            try {
                await addDoc(issuingCollection, newIssuing);
                showNotification('출고 처리가 완료되었습니다.');
                closeIssueModal();
            } catch (error) {
                console.error("Error adding issuing document: ", error);
                showNotification('출고 처리에 실패했습니다.', true);
            }
        }

        function handleDetailClick(e) {
            if (e.target.closest('.remarks-cell') || e.target.closest('.edit-remark-btn')) {
                return; // Don't open detail modal if clicking on remarks
            }
            const row = e.target.closest('tr');
            if (row && row.dataset.name && row.dataset.code) {
                openDetailModal(row.dataset.name, row.dataset.code);
            }
        }

        

        function openIssueModal(e) {
            const button = e.target;
            const id = button.dataset.id;
            const name = button.dataset.name;
            const code = button.dataset.code;
            const stock = button.dataset.stock;
            const unit = button.dataset.unit;

            document.getElementById('issue-receiving-id').value = id;
            document.getElementById('issue-modal-material-name').textContent = name;
            document.getElementById('issue-modal-material-code').textContent = code;
            document.getElementById('issue-modal-batch-stock').textContent = `${formatNumber(stock)} ${unit}`;
            document.getElementById('issue-date').valueAsDate = getKSTDate();
            document.getElementById('issue-unit').value = 'kg';
            
            const receivingDoc = globalReceivingData.find(r => r.id === id);
            if(receivingDoc) {
                document.getElementById('issue-test-no').value = receivingDoc.testNo;
            }

            uiElements.issueModal.classList.remove('hidden');
        }

        function closeIssueModal() {
            uiElements.issuingForm.reset();
            uiElements.issueModal.classList.add('hidden');
        }

        function openDetailModal(materialName, materialCode) {
            document.getElementById('detail-modal-title').textContent = `[${materialName}] 상세 내역`;
            
            const receivingBody = document.getElementById('detail-receiving-list');
            const issuingBody = document.getElementById('detail-issuing-list');
            receivingBody.innerHTML = '';
            issuingBody.innerHTML = '';

            const relevantReceiving = globalReceivingData.filter(r => r.materialName === materialName && r.materialCode === materialCode);
            const receivingIds = relevantReceiving.map(r => r.id);
            const relevantIssuing = globalIssuingData.filter(i => receivingIds.includes(i.receivingId));

            relevantReceiving.forEach(r => {
                const row = receivingBody.insertRow();
                row.innerHTML = `
                    <td class="table-cell text-center">${r.date}</td>
                    <td class="table-cell text-center">${r.testNo}</td>
                    <td class="table-cell text-center">${formatNumber(r.quantity)} ${r.unit}</td>
                    <td class="table-cell text-center">${r.supplier}</td>
                    <td class="table-cell text-center">${r.expiryDate}</td>
                    <td class="table-cell text-left">${r.remarks || ''}</td>
                `;
            });

            relevantIssuing.forEach(i => {
                const row = issuingBody.insertRow();
                row.innerHTML = `
                    <td class="table-cell text-center">${i.date}</td>
                    <td class="table-cell text-center">${i.testNo}</td>
                    <td class="table-cell text-center">${formatNumber(i.quantity)} ${i.unit}</td>
                    <td class="table-cell text-center">${i.productName}</td>
                    <td class="table-cell text-center">${i.mfgNo}</td>
                    <td class="table-cell text-left">${i.remarks || ''}</td>
                `;
            });

            uiElements.detailModal.classList.remove('hidden');
        }

        function closeDetailModal() {
            uiElements.detailModal.classList.add('hidden');
        }

        function openRemarksModal(text) {
            uiElements.remarksModalContent.textContent = text;
            uiElements.remarksModal.classList.remove('hidden');
        }

        function closeRemarksModal() {
            uiElements.remarksModal.classList.add('hidden');
        }

        async function handleEditRemarkClick(docId) {
            const item = globalReceivingData.find(d => d.id === docId);
            if (!item) return;
            
            document.getElementById('edit-remarks-doc-id').value = docId;
            document.getElementById('edit-remarks-textarea').value = item.remarks || '';
            uiElements.editRemarksModal.classList.remove('hidden');
        }

        async function handleEditRemarksSubmit(e) {
            e.preventDefault();
            if (!isDbReady) return;

            const docId = document.getElementById('edit-remarks-doc-id').value;
            const newRemarks = document.getElementById('edit-remarks-textarea').value;
            const docRef = doc(receivingCollection, docId);

            try {
                await updateDoc(docRef, { 
                    remarks: newRemarks,
                    updatedAt: getKSTDate()
                });
                showNotification('비고가 수정되었습니다.');
                uiElements.editRemarksModal.classList.add('hidden');
            } catch (error) {
                console.error("Error updating remarks: ", error);
                showNotification('비고 수정에 실패했습니다.', true);
            }
        }

        function handleExcelUpload(event) {
            const fileInput = event.target;
            const uploadType = fileInput.dataset.uploadType || 'overwrite'; // Default to overwrite for safety
            if (fileInput.files.length > 0) {
                processExcelUpload(fileInput.files[0], uploadType);
            }
        }

        async function processExcelUpload(file, uploadType) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                    const receivingSheet = workbook.Sheets['입고내역'];
                    const issuingSheet = workbook.Sheets['출고내역'];

                    if (!receivingSheet) {
                        throw new Error("'입고내역' 시트를 찾을 수 없습니다.");
                    }

                    const receivingData = XLSX.utils.sheet_to_json(receivingSheet);
                    const issuingData = issuingSheet ? XLSX.utils.sheet_to_json(issuingSheet) : [];
                    
                    if (uploadType === 'overwrite') {
                        if (confirm('엑셀 파일의 데이터로 전체 데이터를 덮어쓰시겠습니까? 기존의 모든 데이터가 삭제됩니다.')) {
                            await clearAndUploadData(receivingData, issuingData);
                        }
                    } else { // append
                        if (confirm('엑셀 파일의 데이터를 기존 데이터에 추가하시겠습니까?')) {
                            await appendData(receivingData, issuingData);
                        }
                    }

                } catch (error) {
                    console.error('Excel processing error:', error);
                    showNotification(`엑셀 처리 중 오류 발생: ${error.message}`, true);
                } finally {
                    // Clear the file input so the same file can be selected again
                    uiElements.excelUploadInput.value = '';
                }
            };
            reader.onerror = (error) => {
                console.error('File reading error:', error);
                showNotification('파일을 읽는 중 오류가 발생했습니다.', true);
                uiElements.excelUploadInput.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        async function clearAndUploadData(receivingData, issuingData) {
            if (!isDbReady) {
                showNotification('데이터베이스에 연결되지 않았습니다.', true);
                return;
            }
            showNotification('기존 데이터 삭제 중...');
            
            const batch = writeBatch(db);

            // Delete all existing documents
            const existingReceiving = await getDocs(receivingCollection);
            existingReceiving.forEach(doc => batch.delete(doc.ref));
            
            const existingIssuing = await getDocs(issuingCollection);
            existingIssuing.forEach(doc => batch.delete(doc.ref));

            await batch.commit();
            showNotification('기존 데이터 삭제 완료. 새 데이터 업로드 중...');

            // Upload new data
            await appendData(receivingData, issuingData, true);
        }

        async function appendData(receivingData, issuingData, isOverwrite = false) {
            if (!isDbReady) {
                showNotification('데이터베이스에 연결되지 않았습니다.', true);
                return;
            }

            const uploadBatch = writeBatch(db);
            const receivingMap = new Map(); // To map old ID to new doc ref

            for (const item of receivingData) {
                const newReceivingDoc = {
                    date: formatDateFromExcel(item['입고일']),
                    materialName: item['원료명'],
                    materialCode: item['원료 코드'],
                    testNo: item['시험번호'],
                    quantity: item['입고량'],
                    unit: item['단위'],
                    specificGravity: item['비중'] || '',
                    manufacturer: item['원료사'] || '',
                    supplier: item['업체명'],
                    expiryDate: formatDateFromExcel(item['유통기한']),
                    remarks: item['비고'] || '',
                    createdAt: getKSTDate()
                };
                const newDocRef = doc(receivingCollection);
                uploadBatch.set(newDocRef, newReceivingDoc);
                receivingMap.set(item['ID'], newDocRef.id); // Store mapping from Excel ID to new Firestore ID
            }

            for (const item of issuingData) {
                const newReceivingId = receivingMap.get(item['입고 ID']);
                if (!newReceivingId) {
                    console.warn(`Could not find matching receiving ID for issuing item:`, item);
                    continue; // Skip if no matching receiving doc
                }
                const newIssuingDoc = {
                    receivingId: newReceivingId,
                    date: formatDateFromExcel(item['출고일']),
                    quantity: item['출고량'],
                    unit: item['단위'],
                    materialName: item['원료명'],
                    materialCode: item['원료 코드'],
                    testNo: item['시험번호'],
                    productName: item['제품명'],
                    mfgNo: item['제조번호'],
                    remarks: item['비고'] || '',
                    createdAt: getKSTDate()
                };
                uploadBatch.set(doc(issuingCollection), newIssuingDoc);
            }

            await uploadBatch.commit();
            const message = isOverwrite ? '엑셀 데이터 덮어쓰기가 완료되었습니다.' : '엑셀 데이터 추가가 완료되었습니다.';
            showNotification(message);
        }

        function generateAndDownloadExcel() {
            try {
                const wb = XLSX.utils.book_new();

                // Prepare receiving data with remaining stock
                const issuedQtys = {};
                globalIssuingData.forEach(issue => {
                    issuedQtys[issue.receivingId] = (issuedQtys[issue.receivingId] || 0) + parseFormattedNumber(issue.quantity);
                });
                const receivingExportData = globalReceivingData.map(item => ({
                    'ID': item.id,
                    '입고일': item.date,
                    '원료명': item.materialName,
                    '원료 코드': item.materialCode,
                    '시험번호': item.testNo,
                    '입고량': parseFormattedNumber(item.quantity),
                    '단위': item.unit,
                    '비중': item.specificGravity || '',
                    '남은 재고': parseFormattedNumber(item.quantity) - (issuedQtys[item.id] || 0),
                    '원료사': item.manufacturer || '',
                    '업체명': item.supplier,
                    '유통기한': item.expiryDate,
                    '비고': item.remarks || ''
                }));

                // Prepare issuing data
                const issuingExportData = globalIssuingData.map(item => ({
                    'ID': item.id,
                    '입고 ID': item.receivingId,
                    '출고일': item.date,
                    '원료명': item.materialName,
                    '원료 코드': item.materialCode,
                    '시험번호': item.testNo,
                    '출고량': parseFormattedNumber(item.quantity),
                    '단위': item.unit,
                    '제품명': item.productName,
                    '제조번호': item.mfgNo,
                    '비고': item.remarks || ''
                }));
                
                // Prepare inventory data
                const inventory = {};
                 globalReceivingData.forEach(item => {
                    const key = `${item.materialName}_${item.materialCode}`;
                    if (!inventory[key]) {
                        inventory[key] = { name: item.materialName, code: item.materialCode, batches: [] };
                    }
                    const remainingStock = parseFormattedNumber(item.quantity) - (issuedQtys[item.id] || 0);
                    if (remainingStock > 0) {
                        inventory[key].batches.push({ ...item, remainingStock });
                    }
                });
                const inventoryExportData = Object.values(inventory).map(item => {
                    const stockByUnit = {};
                    let earliestExpiryDate = null;
                    item.batches.forEach(batch => {
                        const unit = batch.unit || 'N/A';
                        if (!stockByUnit[unit]) stockByUnit[unit] = 0;
                        stockByUnit[unit] += batch.remainingStock;
                        if (!earliestExpiryDate || new Date(batch.expiryDate) < new Date(earliestExpiryDate)) {
                            earliestExpiryDate = batch.expiryDate;
                        }
                    });
                    const stockStrings = Object.entries(stockByUnit).map(([unit, qty]) => `${formatNumber(qty)} ${unit}`).join(', ');
                    const today = getKSTDate();
                    today.setHours(0, 0, 0, 0);
                    const expiryDate = earliestExpiryDate ? new Date(earliestExpiryDate + 'T00:00:00') : null;
                    const remainingDays = expiryDate ? Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24)) : '';
                    return {
                        '원료명': item.name,
                        '원료 코드': item.code,
                        '현 재고': stockStrings,
                        '가장 빠른 유통기한': earliestExpiryDate,
                        '잔여일': remainingDays >= 0 ? `${remainingDays}일` : '만료'
                    };
                }).filter(item => item['현 재고'] !== '');


                const wsReceiving = XLSX.utils.json_to_sheet(receivingExportData);
                const wsIssuing = XLSX.utils.json_to_sheet(issuingExportData);
                const wsInventory = XLSX.utils.json_to_sheet(inventoryExportData);

                XLSX.utils.book_append_sheet(wb, wsReceiving, "입고내역");
                XLSX.utils.book_append_sheet(wb, wsIssuing, "출고내역");
                XLSX.utils.book_append_sheet(wb, wsInventory, "재고현황");

                const today = getKSTDate().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `원료수불부_${today}.xlsx`);
                showNotification('엑셀 파일이 다운로드되었습니다.');

            } catch (error) {
                console.error("Excel generation failed: ", error);
                showNotification('엑셀 생성에 실패했습니다.', true);
            }
        }
    </script>
</body>
</html>
